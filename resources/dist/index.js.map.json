{"version":3,"sources":["/w/extensions/Popups/webpack/bootstrap","/w/extensions/Popups/./src/ui/templates/pagePreview/pagePreview.html","/w/extensions/Popups/./src/ui/templates/popup/popup.html","/w/extensions/Popups/./src/ui/templates/preview/preview.html","/w/extensions/Popups/./node_modules/redux-thunk/dist/redux-thunk.js","/w/extensions/Popups/./node_modules/redux/dist/redux.js","/w/extensions/Popups/(webpack)/buildin/global.js","/w/extensions/Popups/(webpack)/buildin/module.js","/w/extensions/Popups/./src/actionTypes.js","/w/extensions/Popups/./src/actions.js","/w/extensions/Popups/./src/bracketedPixelRatio.js","/w/extensions/Popups/./src/changeListener.js","/w/extensions/Popups/./src/changeListeners/eventLogging.js","/w/extensions/Popups/./src/changeListeners/footerLink.js","/w/extensions/Popups/./src/changeListeners/index.js","/w/extensions/Popups/./src/changeListeners/pageviews.js","/w/extensions/Popups/./src/changeListeners/render.js","/w/extensions/Popups/./src/changeListeners/settings.js","/w/extensions/Popups/./src/changeListeners/statsv.js","/w/extensions/Popups/./src/changeListeners/syncUserSettings.js","/w/extensions/Popups/./src/constants.js","/w/extensions/Popups/./src/counts.js","/w/extensions/Popups/./src/experiments.js","/w/extensions/Popups/./src/formatter.js","/w/extensions/Popups/./src/gateway/mediawiki.js","/w/extensions/Popups/./src/gateway/page.js","/w/extensions/Popups/./src/gateway/reference.js","/w/extensions/Popups/./src/gateway/rest.js","/w/extensions/Popups/./src/gateway/restFormatters.js","/w/extensions/Popups/./src/getPageviewTracker.js","/w/extensions/Popups/./src/index.js","/w/extensions/Popups/./src/instrumentation/eventLogging.js","/w/extensions/Popups/./src/instrumentation/statsv.js","/w/extensions/Popups/./src/integrations/mwpopups.js","/w/extensions/Popups/./src/isEnabled.js","/w/extensions/Popups/./src/preview/model.js","/w/extensions/Popups/./src/previewBehavior.js","/w/extensions/Popups/./src/reducers/eventLogging.js","/w/extensions/Popups/./src/reducers/index.js","/w/extensions/Popups/./src/reducers/nextState.js","/w/extensions/Popups/./src/reducers/pageviews.js","/w/extensions/Popups/./src/reducers/preview.js","/w/extensions/Popups/./src/reducers/settings.js","/w/extensions/Popups/./src/reducers/statsv.js","/w/extensions/Popups/./src/title.js","/w/extensions/Popups/./src/ui/renderer.js","/w/extensions/Popups/./src/ui/settingsDialog.js","/w/extensions/Popups/./src/ui/settingsDialogRenderer.js","/w/extensions/Popups/./src/ui/templates/pagePreview/pagePreview.js","/w/extensions/Popups/./src/ui/templates/popup/popup.js","/w/extensions/Popups/./src/ui/templates/preview/preview.js","/w/extensions/Popups/./src/ui/templates/referencePreview/referencePreview.js","/w/extensions/Popups/./src/ui/templates/settingsDialog/settingsDialog.js","/w/extensions/Popups/./src/ui/templates/templateUtil.js","/w/extensions/Popups/./src/ui/thumbnail.js","/w/extensions/Popups/./src/userSettings.js","/w/extensions/Popups/./src/wait.js"],"names":["BOOT","LINK_DWELL","ABANDON_START","ABANDON_END","LINK_CLICK","FETCH_START","FETCH_END","FETCH_COMPLETE","FETCH_FAILED","FETCH_ABORTED","PAGEVIEW_LOGGED","PREVIEW_DWELL","PREVIEW_SHOW","PREVIEW_CLICK","PREVIEW_SEEN","SETTINGS_SHOW","SETTINGS_HIDE","SETTINGS_CHANGE","EVENT_LOGGED","STATSV_LOGGED","FETCH_START_DELAY","PREVIEW_SEEN_DURATION","FETCH_COMPLETE_TARGET_DELAY","FETCH_DELAY_REFERENCE_TYPE","ABANDON_END_DELAY","timedAction","baseAction","timestamp","mw","now","boot","isEnabled","user","userSettings","config","url","editCount","get","previewCount","getPreviewCount","type","types","isNavPopupsEnabled","sessionToken","sessionId","pageToken","getPageviewToken","page","title","namespaceId","id","isAnon","getDwellDelay","previewTypes","TYPE_PAGE","TYPE_REFERENCE","fetch","gateway","el","token","titleText","getPrefixedDb","namespace","dispatch","xhr","fetchPreviewForTitle","promise","chain","then","result","catch","err","data","exception","Error","fetchType","textStatus","$","when","wait","ex","showNullPreview","readyState","isNetworkError","createNullModel","getUrl","linkDwell","event","generateToken","getState","action","isNewInteraction","preview","activeToken","Deferred","resolve","previewState","enabled","abandon","abort","linkClick","previewDwell","previewShow","state","fetchResponse","currentToken","validType","TYPE_DISAMBIGUATION","indexOf","pageId","pageviewLogged","showSettings","hideSettings","saveSettings","wasEnabled","eventLogged","statsvLogged","dpr","window","devicePixelRatio","registerChangeListener","store","callback","subscribe","prevState","eventLogging","boundActions","eventLoggingTracker","getCurrentTimestamp","_","eventLoggingObj","extend","baseData","createFooterLink","$link","append","attr","text","message","hide","$footer","length","parent","footerLink","$footerLink","undefined","on","e","preventDefault","settings","shouldShowFooterLink","show","pageviews","render","statsv","syncUserSettings","pageviewTracker","pageview","source_page_id","source_namespace","source_title","source_url","previewBehavior","shouldShow","renderer","activeEvent","settingsObj","appendTo","document","body","setEnabled","showHelp","toggleHelp","track","statsvObj","syncIfChanged","setPreviewCount","setIsEnabled","reducer","prop","sync","current","bpr","bracketedPixelRatio","BRACKETED_DEVICE_PIXEL_RATIO","THUMBNAIL_SIZE","EXTRACT_LENGTH","exports","getEditCountBucket","count","bucket","getPreviewCountBucket","createExperiments","mwExperiments","weightedBoolean","name","trueWeight","getBucket","buckets","true","false","formatPlainTextExtract","plainTextExtract","extract","makeTitleInExtractBold","elements","boldIdentifier","Math","random","snip","replace","trim","escapedTitle","util","escapeRegExp","regExp","RegExp","split","forEach","part","push","substring","createTextNode","CACHE_LIFETIME","createMediaWikiApiGateway","api","formatversion","redirects","exintro","exchars","explaintext","piprop","pithumbsize","pilicense","rvprop","inprop","titles","smaxage","maxage","uselang","headers","acceptLanguage","extractPageFromResponse","convertPageToModel","query","pages","formatter","createModel","canonicalurl","pagelanguagehtmlcode","pagelanguagedir","thumbnail","pageid","createPagePreviewGateway","gatewayConfig","constants","restConfig","endpoint","Api","createRESTBaseGateway","ajax","formatters","createReferenceGateway","scrapeReferenceText","idSelector","escapeSelector","scrapeReferenceType","$referenceText","find","each","index","nextType","className","getFragment","children","reject","model","html","referenceType","sourceElementId","parentNode","RESTBASE_PROFILE","extractParser","encodeURIComponent","Accept","jqXHR","errorThrown","isSafeImgFormat","filename","safeImage","test","generateThumbnailData","original","thumbSize","parts","source","lastPart","originalIsSafe","filenamePxIndex","substr","width","height","floor","join","Title","lang","dir","originalimage","parseHTMLResponse","extract_html","parseHTML","parsePlainTextResponse","titleCase","word","toUpperCase","slice","limitByEncodedURILength","sourceUrl","maxLength","truncatedUrl","every","char","prepareEventData","eventData","newFromText","page_title","getPageviewTracker","loader","trackerGetter","sendBeacon","topic","schema","dependencies","evLog","payload","prepare","makeBeaconUrl","getSendBeacon","navigatorObj","bind","createElement","src","EXCLUDED_LINK_SELECTORS","getStatsvTracker","experiments","isStatsvEnabled","getEventLoggingTracker","isEventLoggingEnabled","performance","round","registerChangeListeners","registerActions","settingsDialog","statsvTracker","callbackCurrentTimestamp","changeListeners","actions","init","compose","Redux","generateRandomSessionId","pagePreviewGateway","referenceGateway","createUserSettings","storage","createSettingsDialogRenderer","using","eventLog","navigator","createIsEnabled","process","__REDUX_DEVTOOLS_EXTENSION_COMPOSE__","reducers","ReduxThunk","createPreviewBehavior","location","href","popups","createMediaWikiPopupsObject","selectors","options","excludedLinksSelector","log","error","validLinkSelector","rendererInit","eligibleElements","querySelectorAll","addPopupEventHandlers","target","mwTitle","titleFromElement","removeAttribute","gateways","showPopup","clientX","clientY","clientRect","eventType","getPreviewType","pageXOffset","pageYOffset","innerWidth","innerHeight","hidePopup","getNearestClientRect","rects","y","Array","from","reduce","rect","deltaY","abs","top","bottom","Number","MAX_VALUE","addEventListener","maxLinkWidthForCenteredPointer","clientRects","getClientRects","left","targetRect","filter","element","matches","bucketingRate","createMwPopups","hasIsEnabled","getIsEnabled","TYPE_GENERIC","languageCode","languageDirection","processedExtract","processExtract","previewType","getPagePreviewType","isSelfLink","hasClass","getNamespaceId","getMainText","settingsUrl","rawTitle","previewAbandon","click","getBaseData","bootAction","pageTitleSource","namespaceIdSource","pageIdSource","popupEnabled","previewCountBucket","counts","hovercardsSuppressedByGadget","editCountBucket","createEvent","interaction","actionData","linkInteractionToken","pageTitleHover","namespaceIdHover","timeToPreviewShow","perceivedWait","createClosingEvent","totalInteractionTime","finished","started","finalized","nextCount","newState","actionTypesWithTokens","actionTypes","nextState","link","isUserDwelling","updates","hasOwn","Object","prototype","hasOwnProperty","key","call","page_id","page_namespace","activeLink","wasClicked","fetchStartedAt","linkDwellStartedAt","isOwnPageAnchorLink","hash","host","pathname","search","getTitle","linkHref","Uri","hostname","queryLength","keys","pattern","exec","path","decodeURIComponent","fragment","isValid","contentNamespaces","fromElement","$window","createPreviewWithType","documentElement","getAttribute","createPagePreview","createDisambiguationPreview","createReferencePreview","createEmptyPreview","createThumbnail","hasThumbnail","renderPagePreview","isTall","showTitle","extractMsg","msg","linkMsg","renderPreview","renderReferencePreview","behavior","container","flippedX","flippedY","offsetCorrection","layout","pageX","previewElement","style","dataset","setProperty","orientation","placement","alignment","appendChild","classList","contains","querySelector","trigger","bindBehavior","once","setTimeout","settingsIcon","setAttribute","stopPropagation","Promise","createSettingsDialog","navPopupsEnabled","choices","description","isChecked","splice","renderSettingsDialog","heading","closeLabel","saveLabel","helpText","okLabel","$dialog","$overlay","addClass","selected","getSelectedSetting","visible","$el","val","formSelectors","helpSelectors","pg","fn","disablePopups","cloneFragment","createTemplate","templateHTML","previousElement","previousModel","discreet","isNarrow","add","footer","narrow","offset","renderPopup","popup","innerElement","firstChild","remove","escapeHTML","titleElement","linkElement","innerHTML","KNOWN_TYPES","LOGGING_SCHEMA","isTracking","titleMsg","i","a","rel","replaceWith","removeClass","tabindex","scrolledToBottom","scrollTop","scrollHeight","clientHeight","isOpenRecorded","scrollbarsPresent","isScrollRecorded","isScrolling","$extract","hasHorizontalScroll","scrollWidth","clientWidth","scrollbarHeight","offsetHeight","hasVerticalScroll","scrollbarWidth","offsetWidth","css","right","toggleClass","escapeChoices","map","str","escape","template","getTemplate","content","cloneNode","SIZES","portraitImage","h","w","landscapeImage","rawThumbnail","tall","thumbWidth","thumbHeight","x","IS_ENABLED_KEY","PREVIEW_COUNT_KEY","set","value","Boolean","parseInt","isNaN","toString","delay","deferred"],"mappings":";AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,kDAA0C,gCAAgC;AAC1E;AACA;;AAEA;AACA;AACA;AACA,gEAAwD,kBAAkB;AAC1E;AACA,yDAAiD,cAAc;AAC/D;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iDAAyC,iCAAiC;AAC1E,wHAAgH,mBAAmB,EAAE;AACrI;AACA;;AAEA;AACA;AACA;AACA,mCAA2B,0BAA0B,EAAE;AACvD,yCAAiC,eAAe;AAChD;AACA;AACA;;AAEA;AACA,8DAAsD,+DAA+D;;AAErH;AACA;;;AAGA;AACA;;;;;;;;;;;;;AClFA;AAAe,oUAAqQ,E;;;;;;;;;;;;ACApR;AAAe,2JAA4F,E;;;;;;;;;;;;ACA3G;AAAe,mTAAoP,E;;;;;;;;;;;ACAnQ;AACA,IAAI,IAAyD;AAC7D;AACA,MAAM,EAK2B;AACjC,CAAC;AACD,oCAAoC;AACpC;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,uBAAuB;AACvB;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;;AAEA;;;AAGA,OAAO;AACP;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA,OAAO;AACP;AACA,CAAC;AACD,C;;;;;;;;;;;AC1FA;AACA,KAA4D;AAC5D,SAC8B;AAC9B,CAAC,4BAA4B;;AAE7B;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,EAAE;AACF;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA,CAAC;AACD;AACA,CAAC;AACD;AACA,CAAC,UAAU,IAA6B;AACxC;AACA,CAAC,MAAM,EAEN;;AAED;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,WAAW,IAAI;AACf,aAAa,QAAQ;AACrB;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,SAAS;AACpB;AACA;AACA,WAAW,IAAI;AACf;AACA;AACA;AACA;AACA;AACA,WAAW,SAAS;AACpB;AACA;AACA;AACA;AACA,aAAa,MAAM;AACnB;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe,IAAI;AACnB;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,SAAS;AACtB,eAAe,SAAS;AACxB;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,OAAO;AACpB;AACA;AACA;AACA;AACA;AACA,eAAe,OAAO;AACtB;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEA;;AAEA,mBAAmB,sBAAsB;AACzC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,SAAS;AACtB,eAAe;AACf;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,eAAe,WAAW;AAC1B;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;AACA;AACA;AACA,iBAAiB,OAAO;AACxB;AACA,mBAAmB,aAAa;AAChC;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA,KAAK;AACL,GAAG;AACH;AACA;;;AAGA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA,WAAW,OAAO;AAClB,aAAa;AACb;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA,GAAG,aAAa;;AAEhB;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA,oEAAoE;AACpE;;AAEA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;;AAEL;AACA;AACA;;AAEA;AACA;AACA,KAAK;AACL;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,OAAO;AAClB;AACA;AACA;AACA;AACA;AACA;AACA,aAAa,SAAS;AACtB;AACA;;;AAGA;AACA;AACA;;AAEA,iBAAiB,wBAAwB;AACzC;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA,GAAG;AACH;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,oBAAoB,8BAA8B;AAClD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,gBAAgB;AAC3B;AACA;AACA;AACA,WAAW,SAAS;AACpB;AACA;AACA,aAAa,gBAAgB;AAC7B;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA,iBAAiB,iBAAiB;AAClC;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL,GAAG;AACH;AACA;;AAEA;AACA;;AAEA;AACA,iBAAiB,sBAAsB;AACvC;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;;AAEA;AACA;AACA,KAAK;AACL;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,WAAW,YAAY;AACvB,aAAa,SAAS;AACtB;AACA;AACA;AACA;AACA,sEAAsE,aAAa;AACnF;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW,YAAY;AACvB,aAAa,SAAS;AACtB;;AAEA;AACA,4EAA4E,aAAa;AACzF;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA,6BAA6B;AAC7B;AACA,OAAO;AACP;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA,8CAA8C,cAAc;;AAE5D,CAAC;;;;;;;;;;;;;AC5qBD;;AAEA;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA,CAAC;AACD;AACA;AACA;;AAEA;AACA;AACA,4CAA4C;;AAE5C;;;;;;;;;;;;ACnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AA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","file":"index.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","export default \"<a class=\\\"mwe-popups-discreet\\\">\\n</a>\\n<a class=\\\"mwe-popups-extract\\\">\\n</a>\\n<footer>\\n    <a class='mwe-popups-settings-icon'>\\n        <span class=\\\"mw-ui-icon mw-ui-icon-small mw-ui-icon-element mw-ui-icon-popups-settings\\\"></span>\\n    </a>\\n</footer>\";","export default \"<div class='mwe-popups' aria-hidden>\\n    <div class='mwe-popups-container'></div>\\n</div>\";","export default \"<div class='mw-ui-icon mw-ui-icon-element'></div>\\n<strong class='mwe-popups-title'></strong>\\n<a class='mwe-popups-extract'>\\n    <span class='mwe-popups-message'></span>\\n</a>\\n<footer>\\n    <a class='mwe-popups-read-link'></a>\\n</footer>\\n\";","(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ReduxThunk\"] = factory();\n\telse\n\t\troot[\"ReduxThunk\"] = factory();\n})(this, function() {\nreturn /******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId])\n/******/ \t\t\treturn installedModules[moduleId].exports;\n\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\texports: {},\n/******/ \t\t\tid: moduleId,\n/******/ \t\t\tloaded: false\n/******/ \t\t};\n\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.loaded = true;\n\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n\n\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = \"\";\n\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(0);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\tmodule.exports = __webpack_require__(1);\n\n\n/***/ }),\n/* 1 */\n/***/ (function(module, exports) {\n\n\t'use strict';\n\n\texports.__esModule = true;\n\tfunction createThunkMiddleware(extraArgument) {\n\t  return function (_ref) {\n\t    var dispatch = _ref.dispatch,\n\t        getState = _ref.getState;\n\t    return function (next) {\n\t      return function (action) {\n\t        if (typeof action === 'function') {\n\t          return action(dispatch, getState, extraArgument);\n\t        }\n\n\t        return next(action);\n\t      };\n\t    };\n\t  };\n\t}\n\n\tvar thunk = createThunkMiddleware();\n\tthunk.withExtraArgument = createThunkMiddleware;\n\n\texports['default'] = thunk;\n\n/***/ })\n/******/ ])\n});\n;","(function (global, factory) {\ntypeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\ntypeof define === 'function' && define.amd ? define(['exports'], factory) :\n(factory((global.Redux = {})));\n}(this, (function (exports) { 'use strict';\n\nfunction symbolObservablePonyfill(root) {\n\tvar result;\n\tvar Symbol = root.Symbol;\n\n\tif (typeof Symbol === 'function') {\n\t\tif (Symbol.observable) {\n\t\t\tresult = Symbol.observable;\n\t\t} else {\n\t\t\tresult = Symbol('observable');\n\t\t\tSymbol.observable = result;\n\t\t}\n\t} else {\n\t\tresult = '@@observable';\n\t}\n\n\treturn result;\n}\n\n/* global window */\n\nvar root;\n\nif (typeof self !== 'undefined') {\n  root = self;\n} else if (typeof window !== 'undefined') {\n  root = window;\n} else if (typeof global !== 'undefined') {\n  root = global;\n} else if (typeof module !== 'undefined') {\n  root = module;\n} else {\n  root = Function('return this')();\n}\n\nvar result = symbolObservablePonyfill(root);\n\n/**\n * These are private action types reserved by Redux.\n * For any unknown actions, you must return the current state.\n * If the current state is undefined, you must return the initial state.\n * Do not reference these action types directly in your code.\n */\nvar randomString = function randomString() {\n  return Math.random().toString(36).substring(7).split('').join('.');\n};\n\nvar ActionTypes = {\n  INIT: \"@@redux/INIT\" + randomString(),\n  REPLACE: \"@@redux/REPLACE\" + randomString(),\n  PROBE_UNKNOWN_ACTION: function PROBE_UNKNOWN_ACTION() {\n    return \"@@redux/PROBE_UNKNOWN_ACTION\" + randomString();\n  }\n};\n\n/**\n * @param {any} obj The object to inspect.\n * @returns {boolean} True if the argument appears to be a plain object.\n */\nfunction isPlainObject(obj) {\n  if (typeof obj !== 'object' || obj === null) return false;\n  var proto = obj;\n\n  while (Object.getPrototypeOf(proto) !== null) {\n    proto = Object.getPrototypeOf(proto);\n  }\n\n  return Object.getPrototypeOf(obj) === proto;\n}\n\n/**\n * Creates a Redux store that holds the state tree.\n * The only way to change the data in the store is to call `dispatch()` on it.\n *\n * There should only be a single store in your app. To specify how different\n * parts of the state tree respond to actions, you may combine several reducers\n * into a single reducer function by using `combineReducers`.\n *\n * @param {Function} reducer A function that returns the next state tree, given\n * the current state tree and the action to handle.\n *\n * @param {any} [preloadedState] The initial state. You may optionally specify it\n * to hydrate the state from the server in universal apps, or to restore a\n * previously serialized user session.\n * If you use `combineReducers` to produce the root reducer function, this must be\n * an object with the same shape as `combineReducers` keys.\n *\n * @param {Function} [enhancer] The store enhancer. You may optionally specify it\n * to enhance the store with third-party capabilities such as middleware,\n * time travel, persistence, etc. The only store enhancer that ships with Redux\n * is `applyMiddleware()`.\n *\n * @returns {Store} A Redux store that lets you read the state, dispatch actions\n * and subscribe to changes.\n */\n\nfunction createStore(reducer, preloadedState, enhancer) {\n  var _ref2;\n\n  if (typeof preloadedState === 'function' && typeof enhancer === 'function' || typeof enhancer === 'function' && typeof arguments[3] === 'function') {\n    throw new Error('It looks like you are passing several store enhancers to ' + 'createStore(). This is not supported. Instead, compose them ' + 'together to a single function');\n  }\n\n  if (typeof preloadedState === 'function' && typeof enhancer === 'undefined') {\n    enhancer = preloadedState;\n    preloadedState = undefined;\n  }\n\n  if (typeof enhancer !== 'undefined') {\n    if (typeof enhancer !== 'function') {\n      throw new Error('Expected the enhancer to be a function.');\n    }\n\n    return enhancer(createStore)(reducer, preloadedState);\n  }\n\n  if (typeof reducer !== 'function') {\n    throw new Error('Expected the reducer to be a function.');\n  }\n\n  var currentReducer = reducer;\n  var currentState = preloadedState;\n  var currentListeners = [];\n  var nextListeners = currentListeners;\n  var isDispatching = false;\n\n  function ensureCanMutateNextListeners() {\n    if (nextListeners === currentListeners) {\n      nextListeners = currentListeners.slice();\n    }\n  }\n  /**\n   * Reads the state tree managed by the store.\n   *\n   * @returns {any} The current state tree of your application.\n   */\n\n\n  function getState() {\n    if (isDispatching) {\n      throw new Error('You may not call store.getState() while the reducer is executing. ' + 'The reducer has already received the state as an argument. ' + 'Pass it down from the top reducer instead of reading it from the store.');\n    }\n\n    return currentState;\n  }\n  /**\n   * Adds a change listener. It will be called any time an action is dispatched,\n   * and some part of the state tree may potentially have changed. You may then\n   * call `getState()` to read the current state tree inside the callback.\n   *\n   * You may call `dispatch()` from a change listener, with the following\n   * caveats:\n   *\n   * 1. The subscriptions are snapshotted just before every `dispatch()` call.\n   * If you subscribe or unsubscribe while the listeners are being invoked, this\n   * will not have any effect on the `dispatch()` that is currently in progress.\n   * However, the next `dispatch()` call, whether nested or not, will use a more\n   * recent snapshot of the subscription list.\n   *\n   * 2. The listener should not expect to see all state changes, as the state\n   * might have been updated multiple times during a nested `dispatch()` before\n   * the listener is called. It is, however, guaranteed that all subscribers\n   * registered before the `dispatch()` started will be called with the latest\n   * state by the time it exits.\n   *\n   * @param {Function} listener A callback to be invoked on every dispatch.\n   * @returns {Function} A function to remove this change listener.\n   */\n\n\n  function subscribe(listener) {\n    if (typeof listener !== 'function') {\n      throw new Error('Expected the listener to be a function.');\n    }\n\n    if (isDispatching) {\n      throw new Error('You may not call store.subscribe() while the reducer is executing. ' + 'If you would like to be notified after the store has been updated, subscribe from a ' + 'component and invoke store.getState() in the callback to access the latest state. ' + 'See https://redux.js.org/api-reference/store#subscribe(listener) for more details.');\n    }\n\n    var isSubscribed = true;\n    ensureCanMutateNextListeners();\n    nextListeners.push(listener);\n    return function unsubscribe() {\n      if (!isSubscribed) {\n        return;\n      }\n\n      if (isDispatching) {\n        throw new Error('You may not unsubscribe from a store listener while the reducer is executing. ' + 'See https://redux.js.org/api-reference/store#subscribe(listener) for more details.');\n      }\n\n      isSubscribed = false;\n      ensureCanMutateNextListeners();\n      var index = nextListeners.indexOf(listener);\n      nextListeners.splice(index, 1);\n    };\n  }\n  /**\n   * Dispatches an action. It is the only way to trigger a state change.\n   *\n   * The `reducer` function, used to create the store, will be called with the\n   * current state tree and the given `action`. Its return value will\n   * be considered the **next** state of the tree, and the change listeners\n   * will be notified.\n   *\n   * The base implementation only supports plain object actions. If you want to\n   * dispatch a Promise, an Observable, a thunk, or something else, you need to\n   * wrap your store creating function into the corresponding middleware. For\n   * example, see the documentation for the `redux-thunk` package. Even the\n   * middleware will eventually dispatch plain object actions using this method.\n   *\n   * @param {Object} action A plain object representing what changed. It is\n   * a good idea to keep actions serializable so you can record and replay user\n   * sessions, or use the time travelling `redux-devtools`. An action must have\n   * a `type` property which may not be `undefined`. It is a good idea to use\n   * string constants for action types.\n   *\n   * @returns {Object} For convenience, the same action object you dispatched.\n   *\n   * Note that, if you use a custom middleware, it may wrap `dispatch()` to\n   * return something else (for example, a Promise you can await).\n   */\n\n\n  function dispatch(action) {\n    if (!isPlainObject(action)) {\n      throw new Error('Actions must be plain objects. ' + 'Use custom middleware for async actions.');\n    }\n\n    if (typeof action.type === 'undefined') {\n      throw new Error('Actions may not have an undefined \"type\" property. ' + 'Have you misspelled a constant?');\n    }\n\n    if (isDispatching) {\n      throw new Error('Reducers may not dispatch actions.');\n    }\n\n    try {\n      isDispatching = true;\n      currentState = currentReducer(currentState, action);\n    } finally {\n      isDispatching = false;\n    }\n\n    var listeners = currentListeners = nextListeners;\n\n    for (var i = 0; i < listeners.length; i++) {\n      var listener = listeners[i];\n      listener();\n    }\n\n    return action;\n  }\n  /**\n   * Replaces the reducer currently used by the store to calculate the state.\n   *\n   * You might need this if your app implements code splitting and you want to\n   * load some of the reducers dynamically. You might also need this if you\n   * implement a hot reloading mechanism for Redux.\n   *\n   * @param {Function} nextReducer The reducer for the store to use instead.\n   * @returns {void}\n   */\n\n\n  function replaceReducer(nextReducer) {\n    if (typeof nextReducer !== 'function') {\n      throw new Error('Expected the nextReducer to be a function.');\n    }\n\n    currentReducer = nextReducer;\n    dispatch({\n      type: ActionTypes.REPLACE\n    });\n  }\n  /**\n   * Interoperability point for observable/reactive libraries.\n   * @returns {observable} A minimal observable of state changes.\n   * For more information, see the observable proposal:\n   * https://github.com/tc39/proposal-observable\n   */\n\n\n  function observable() {\n    var _ref;\n\n    var outerSubscribe = subscribe;\n    return _ref = {\n      /**\n       * The minimal observable subscription method.\n       * @param {Object} observer Any object that can be used as an observer.\n       * The observer object should have a `next` method.\n       * @returns {subscription} An object with an `unsubscribe` method that can\n       * be used to unsubscribe the observable from the store, and prevent further\n       * emission of values from the observable.\n       */\n      subscribe: function subscribe(observer) {\n        if (typeof observer !== 'object' || observer === null) {\n          throw new TypeError('Expected the observer to be an object.');\n        }\n\n        function observeState() {\n          if (observer.next) {\n            observer.next(getState());\n          }\n        }\n\n        observeState();\n        var unsubscribe = outerSubscribe(observeState);\n        return {\n          unsubscribe: unsubscribe\n        };\n      }\n    }, _ref[result] = function () {\n      return this;\n    }, _ref;\n  } // When a store is created, an \"INIT\" action is dispatched so that every\n  // reducer returns their initial state. This effectively populates\n  // the initial state tree.\n\n\n  dispatch({\n    type: ActionTypes.INIT\n  });\n  return _ref2 = {\n    dispatch: dispatch,\n    subscribe: subscribe,\n    getState: getState,\n    replaceReducer: replaceReducer\n  }, _ref2[result] = observable, _ref2;\n}\n\n/**\n * Prints a warning in the console if it exists.\n *\n * @param {String} message The warning message.\n * @returns {void}\n */\nfunction warning(message) {\n  /* eslint-disable no-console */\n  if (typeof console !== 'undefined' && typeof console.error === 'function') {\n    console.error(message);\n  }\n  /* eslint-enable no-console */\n\n\n  try {\n    // This error was thrown as a convenience so that if you enable\n    // \"break on all exceptions\" in your console,\n    // it would pause the execution at this line.\n    throw new Error(message);\n  } catch (e) {} // eslint-disable-line no-empty\n\n}\n\nfunction getUndefinedStateErrorMessage(key, action) {\n  var actionType = action && action.type;\n  var actionDescription = actionType && \"action \\\"\" + String(actionType) + \"\\\"\" || 'an action';\n  return \"Given \" + actionDescription + \", reducer \\\"\" + key + \"\\\" returned undefined. \" + \"To ignore an action, you must explicitly return the previous state. \" + \"If you want this reducer to hold no value, you can return null instead of undefined.\";\n}\n\nfunction getUnexpectedStateShapeWarningMessage(inputState, reducers, action, unexpectedKeyCache) {\n  var reducerKeys = Object.keys(reducers);\n  var argumentName = action && action.type === ActionTypes.INIT ? 'preloadedState argument passed to createStore' : 'previous state received by the reducer';\n\n  if (reducerKeys.length === 0) {\n    return 'Store does not have a valid reducer. Make sure the argument passed ' + 'to combineReducers is an object whose values are reducers.';\n  }\n\n  if (!isPlainObject(inputState)) {\n    return \"The \" + argumentName + \" has unexpected type of \\\"\" + {}.toString.call(inputState).match(/\\s([a-z|A-Z]+)/)[1] + \"\\\". Expected argument to be an object with the following \" + (\"keys: \\\"\" + reducerKeys.join('\", \"') + \"\\\"\");\n  }\n\n  var unexpectedKeys = Object.keys(inputState).filter(function (key) {\n    return !reducers.hasOwnProperty(key) && !unexpectedKeyCache[key];\n  });\n  unexpectedKeys.forEach(function (key) {\n    unexpectedKeyCache[key] = true;\n  });\n  if (action && action.type === ActionTypes.REPLACE) return;\n\n  if (unexpectedKeys.length > 0) {\n    return \"Unexpected \" + (unexpectedKeys.length > 1 ? 'keys' : 'key') + \" \" + (\"\\\"\" + unexpectedKeys.join('\", \"') + \"\\\" found in \" + argumentName + \". \") + \"Expected to find one of the known reducer keys instead: \" + (\"\\\"\" + reducerKeys.join('\", \"') + \"\\\". Unexpected keys will be ignored.\");\n  }\n}\n\nfunction assertReducerShape(reducers) {\n  Object.keys(reducers).forEach(function (key) {\n    var reducer = reducers[key];\n    var initialState = reducer(undefined, {\n      type: ActionTypes.INIT\n    });\n\n    if (typeof initialState === 'undefined') {\n      throw new Error(\"Reducer \\\"\" + key + \"\\\" returned undefined during initialization. \" + \"If the state passed to the reducer is undefined, you must \" + \"explicitly return the initial state. The initial state may \" + \"not be undefined. If you don't want to set a value for this reducer, \" + \"you can use null instead of undefined.\");\n    }\n\n    if (typeof reducer(undefined, {\n      type: ActionTypes.PROBE_UNKNOWN_ACTION()\n    }) === 'undefined') {\n      throw new Error(\"Reducer \\\"\" + key + \"\\\" returned undefined when probed with a random type. \" + (\"Don't try to handle \" + ActionTypes.INIT + \" or other actions in \\\"redux/*\\\" \") + \"namespace. They are considered private. Instead, you must return the \" + \"current state for any unknown actions, unless it is undefined, \" + \"in which case you must return the initial state, regardless of the \" + \"action type. The initial state may not be undefined, but can be null.\");\n    }\n  });\n}\n/**\n * Turns an object whose values are different reducer functions, into a single\n * reducer function. It will call every child reducer, and gather their results\n * into a single state object, whose keys correspond to the keys of the passed\n * reducer functions.\n *\n * @param {Object} reducers An object whose values correspond to different\n * reducer functions that need to be combined into one. One handy way to obtain\n * it is to use ES6 `import * as reducers` syntax. The reducers may never return\n * undefined for any action. Instead, they should return their initial state\n * if the state passed to them was undefined, and the current state for any\n * unrecognized action.\n *\n * @returns {Function} A reducer function that invokes every reducer inside the\n * passed object, and builds a state object with the same shape.\n */\n\n\nfunction combineReducers(reducers) {\n  var reducerKeys = Object.keys(reducers);\n  var finalReducers = {};\n\n  for (var i = 0; i < reducerKeys.length; i++) {\n    var key = reducerKeys[i];\n\n    {\n      if (typeof reducers[key] === 'undefined') {\n        warning(\"No reducer provided for key \\\"\" + key + \"\\\"\");\n      }\n    }\n\n    if (typeof reducers[key] === 'function') {\n      finalReducers[key] = reducers[key];\n    }\n  }\n\n  var finalReducerKeys = Object.keys(finalReducers);\n  var unexpectedKeyCache;\n\n  {\n    unexpectedKeyCache = {};\n  }\n\n  var shapeAssertionError;\n\n  try {\n    assertReducerShape(finalReducers);\n  } catch (e) {\n    shapeAssertionError = e;\n  }\n\n  return function combination(state, action) {\n    if (state === void 0) {\n      state = {};\n    }\n\n    if (shapeAssertionError) {\n      throw shapeAssertionError;\n    }\n\n    {\n      var warningMessage = getUnexpectedStateShapeWarningMessage(state, finalReducers, action, unexpectedKeyCache);\n\n      if (warningMessage) {\n        warning(warningMessage);\n      }\n    }\n\n    var hasChanged = false;\n    var nextState = {};\n\n    for (var _i = 0; _i < finalReducerKeys.length; _i++) {\n      var _key = finalReducerKeys[_i];\n      var reducer = finalReducers[_key];\n      var previousStateForKey = state[_key];\n      var nextStateForKey = reducer(previousStateForKey, action);\n\n      if (typeof nextStateForKey === 'undefined') {\n        var errorMessage = getUndefinedStateErrorMessage(_key, action);\n        throw new Error(errorMessage);\n      }\n\n      nextState[_key] = nextStateForKey;\n      hasChanged = hasChanged || nextStateForKey !== previousStateForKey;\n    }\n\n    return hasChanged ? nextState : state;\n  };\n}\n\nfunction bindActionCreator(actionCreator, dispatch) {\n  return function () {\n    return dispatch(actionCreator.apply(this, arguments));\n  };\n}\n/**\n * Turns an object whose values are action creators, into an object with the\n * same keys, but with every function wrapped into a `dispatch` call so they\n * may be invoked directly. This is just a convenience method, as you can call\n * `store.dispatch(MyActionCreators.doSomething())` yourself just fine.\n *\n * For convenience, you can also pass a single function as the first argument,\n * and get a function in return.\n *\n * @param {Function|Object} actionCreators An object whose values are action\n * creator functions. One handy way to obtain it is to use ES6 `import * as`\n * syntax. You may also pass a single function.\n *\n * @param {Function} dispatch The `dispatch` function available on your Redux\n * store.\n *\n * @returns {Function|Object} The object mimicking the original object, but with\n * every action creator wrapped into the `dispatch` call. If you passed a\n * function as `actionCreators`, the return value will also be a single\n * function.\n */\n\n\nfunction bindActionCreators(actionCreators, dispatch) {\n  if (typeof actionCreators === 'function') {\n    return bindActionCreator(actionCreators, dispatch);\n  }\n\n  if (typeof actionCreators !== 'object' || actionCreators === null) {\n    throw new Error(\"bindActionCreators expected an object or a function, instead received \" + (actionCreators === null ? 'null' : typeof actionCreators) + \". \" + \"Did you write \\\"import ActionCreators from\\\" instead of \\\"import * as ActionCreators from\\\"?\");\n  }\n\n  var keys = Object.keys(actionCreators);\n  var boundActionCreators = {};\n\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    var actionCreator = actionCreators[key];\n\n    if (typeof actionCreator === 'function') {\n      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch);\n    }\n  }\n\n  return boundActionCreators;\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    var ownKeys = Object.keys(source);\n\n    if (typeof Object.getOwnPropertySymbols === 'function') {\n      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(source, sym).enumerable;\n      }));\n    }\n\n    ownKeys.forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    });\n  }\n\n  return target;\n}\n\n/**\n * Composes single-argument functions from right to left. The rightmost\n * function can take multiple arguments as it provides the signature for\n * the resulting composite function.\n *\n * @param {...Function} funcs The functions to compose.\n * @returns {Function} A function obtained by composing the argument functions\n * from right to left. For example, compose(f, g, h) is identical to doing\n * (...args) => f(g(h(...args))).\n */\nfunction compose() {\n  for (var _len = arguments.length, funcs = new Array(_len), _key = 0; _key < _len; _key++) {\n    funcs[_key] = arguments[_key];\n  }\n\n  if (funcs.length === 0) {\n    return function (arg) {\n      return arg;\n    };\n  }\n\n  if (funcs.length === 1) {\n    return funcs[0];\n  }\n\n  return funcs.reduce(function (a, b) {\n    return function () {\n      return a(b.apply(void 0, arguments));\n    };\n  });\n}\n\n/**\n * Creates a store enhancer that applies middleware to the dispatch method\n * of the Redux store. This is handy for a variety of tasks, such as expressing\n * asynchronous actions in a concise manner, or logging every action payload.\n *\n * See `redux-thunk` package as an example of the Redux middleware.\n *\n * Because middleware is potentially asynchronous, this should be the first\n * store enhancer in the composition chain.\n *\n * Note that each middleware will be given the `dispatch` and `getState` functions\n * as named arguments.\n *\n * @param {...Function} middlewares The middleware chain to be applied.\n * @returns {Function} A store enhancer applying the middleware.\n */\n\nfunction applyMiddleware() {\n  for (var _len = arguments.length, middlewares = new Array(_len), _key = 0; _key < _len; _key++) {\n    middlewares[_key] = arguments[_key];\n  }\n\n  return function (createStore) {\n    return function () {\n      var store = createStore.apply(void 0, arguments);\n\n      var _dispatch = function dispatch() {\n        throw new Error(\"Dispatching while constructing your middleware is not allowed. \" + \"Other middleware would not be applied to this dispatch.\");\n      };\n\n      var middlewareAPI = {\n        getState: store.getState,\n        dispatch: function dispatch() {\n          return _dispatch.apply(void 0, arguments);\n        }\n      };\n      var chain = middlewares.map(function (middleware) {\n        return middleware(middlewareAPI);\n      });\n      _dispatch = compose.apply(void 0, chain)(store.dispatch);\n      return _objectSpread({}, store, {\n        dispatch: _dispatch\n      });\n    };\n  };\n}\n\n/*\n * This is a dummy function to check if the function name has been altered by minification.\n * If the function has been minified and NODE_ENV !== 'production', warn the user.\n */\n\nfunction isCrushed() {}\n\nif (typeof isCrushed.name === 'string' && isCrushed.name !== 'isCrushed') {\n  warning('You are currently using minified code outside of NODE_ENV === \"production\". ' + 'This means that you are running a slower development build of Redux. ' + 'You can use loose-envify (https://github.com/zertosh/loose-envify) for browserify ' + 'or setting mode to production in webpack (https://webpack.js.org/concepts/mode/) ' + 'to ensure you have the correct code for your production build.');\n}\n\nexports.createStore = createStore;\nexports.combineReducers = combineReducers;\nexports.bindActionCreators = bindActionCreators;\nexports.applyMiddleware = applyMiddleware;\nexports.compose = compose;\nexports.__DO_NOT_USE__ActionTypes = ActionTypes;\n\nObject.defineProperty(exports, '__esModule', { value: true });\n\n})));\n","var g;\n\n// This works in non-strict mode\ng = (function() {\n\treturn this;\n})();\n\ntry {\n\t// This works if eval is allowed (see CSP)\n\tg = g || new Function(\"return this\")();\n} catch (e) {\n\t// This works if the window reference is available\n\tif (typeof window === \"object\") g = window;\n}\n\n// g can still be undefined, but nothing to do about it...\n// We return undefined, instead of nothing here, so it's\n// easier to handle this case. if(!global) { ...}\n\nmodule.exports = g;\n","module.exports = function(module) {\n\tif (!module.webpackPolyfill) {\n\t\tmodule.deprecate = function() {};\n\t\tmodule.paths = [];\n\t\t// module.parent = undefined by default\n\t\tif (!module.children) module.children = [];\n\t\tObject.defineProperty(module, \"loaded\", {\n\t\t\tenumerable: true,\n\t\t\tget: function() {\n\t\t\t\treturn module.l;\n\t\t\t}\n\t\t});\n\t\tObject.defineProperty(module, \"id\", {\n\t\t\tenumerable: true,\n\t\t\tget: function() {\n\t\t\t\treturn module.i;\n\t\t\t}\n\t\t});\n\t\tmodule.webpackPolyfill = 1;\n\t}\n\treturn module;\n};\n","/**\n * @module actionTypes\n */\n\nexport default {\n\tBOOT: 'BOOT',\n\tLINK_DWELL: 'LINK_DWELL',\n\tABANDON_START: 'ABANDON_START',\n\tABANDON_END: 'ABANDON_END',\n\tLINK_CLICK: 'LINK_CLICK',\n\t/** Precedes a fetch. */\n\tFETCH_START: 'FETCH_START',\n\t/** Follows a successful fetch. */\n\tFETCH_END: 'FETCH_END',\n\t/** Follows a fetch regardless of whether it was successful. */\n\tFETCH_COMPLETE: 'FETCH_COMPLETE',\n\t/** Follows an unsuccessful fetch. */\n\tFETCH_FAILED: 'FETCH_FAILED',\n\t/** Follows an aborted fetch */\n\tFETCH_ABORTED: 'FETCH_ABORTED',\n\tPAGEVIEW_LOGGED: 'PAGEVIEW_LOGGED',\n\tPREVIEW_DWELL: 'PREVIEW_DWELL',\n\tPREVIEW_SHOW: 'PREVIEW_SHOW',\n\tPREVIEW_CLICK: 'PREVIEW_CLICK',\n\t/**\n\t\tOccurs when a preview has been opened for a significant amount of time and\n\t\tis assumed to have been viewed.\n\t */\n\tPREVIEW_SEEN: 'PREVIEW_SEEN',\n\tSETTINGS_SHOW: 'SETTINGS_SHOW',\n\tSETTINGS_HIDE: 'SETTINGS_HIDE',\n\tSETTINGS_CHANGE: 'SETTINGS_CHANGE',\n\tEVENT_LOGGED: 'EVENT_LOGGED',\n\tSTATSV_LOGGED: 'STATSV_LOGGED'\n};\n","/**\n * @module actions\n */\n\nimport types from './actionTypes';\nimport wait from './wait';\nimport { createNullModel, previewTypes } from './preview/model';\n\nconst\n\t// See the following for context around this value.\n\t//\n\t// * https://phabricator.wikimedia.org/T161284\n\t// * https://phabricator.wikimedia.org/T70861#3129780\n\tFETCH_START_DELAY = 150, // ms.\n\n\t// The minimum time a preview must be open before we judge it\n\t// has been seen.\n\t// See https://phabricator.wikimedia.org/T184793\n\tPREVIEW_SEEN_DURATION = 1000, // ms\n\n\t// The delay after which a FETCH_COMPLETE action should be dispatched.\n\t//\n\t// If the API endpoint responds faster than 350 ms (or, say, the API\n\t// response is served from the UA's cache), then we introduce a delay of\n\t// 350 ms - t to make the preview delay consistent to the user. The total\n\t// delay from start to finish is 500 ms.\n\tFETCH_COMPLETE_TARGET_DELAY = 350 + FETCH_START_DELAY, // ms.\n\n\tFETCH_DELAY_REFERENCE_TYPE = 150, // ms.\n\n\tABANDON_END_DELAY = 300; // ms.\n\n/**\n * Mixes in timing information to an action.\n *\n * Warning: the `baseAction` parameter is modified and returned.\n *\n * @param {Object} baseAction\n * @return {Object}\n */\nfunction timedAction( baseAction ) {\n\tbaseAction.timestamp = mw.now();\n\n\treturn baseAction;\n}\n\n/**\n * Represents Page Previews booting.\n *\n * When a Redux store is created, the `@@INIT` action is immediately\n * dispatched to it. To avoid overriding the term, we refer to booting rather\n * than initializing.\n *\n * Page Previews persists critical pieces of information to local storage.\n * Since reading from and writing to local storage are synchronous, Page\n * Previews is booted when the browser is idle (using\n * [`mw.requestIdleCallback`](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback))\n * so as not to impact latency-critical events.\n *\n * @param {boolean} isEnabled See `isEnabled.js`\n * @param {mw.user} user\n * @param {ext.popups.UserSettings} userSettings\n * @param {mw.Map} config The config of the MediaWiki client-side application,\n *  i.e. `mw.config`\n * @param {string} url url\n * @return {Object}\n */\nexport function boot(\n\tisEnabled,\n\tuser,\n\tuserSettings,\n\tconfig,\n\turl\n) {\n\tconst editCount = config.get( 'wgUserEditCount' ),\n\t\tpreviewCount = userSettings.getPreviewCount();\n\n\treturn {\n\t\ttype: types.BOOT,\n\t\tisEnabled,\n\t\tisNavPopupsEnabled: config.get( 'wgPopupsConflictsWithNavPopupGadget' ),\n\t\tsessionToken: user.sessionId(),\n\t\tpageToken: user.getPageviewToken(),\n\t\tpage: {\n\t\t\turl,\n\t\t\ttitle: config.get( 'wgTitle' ),\n\t\t\tnamespaceId: config.get( 'wgNamespaceNumber' ),\n\t\t\tid: config.get( 'wgArticleId' )\n\t\t},\n\t\tuser: {\n\t\t\tisAnon: user.isAnon(),\n\t\t\teditCount,\n\t\t\tpreviewCount\n\t\t}\n\t};\n}\n\n/**\n * Determines the delay before showing the preview when dwelling a link.\n *\n * @param {string} type\n * @return {number}\n */\nfunction getDwellDelay( type ) {\n\tswitch ( type ) {\n\t\tcase previewTypes.TYPE_PAGE:\n\t\t\treturn FETCH_COMPLETE_TARGET_DELAY - FETCH_START_DELAY;\n\t\tcase previewTypes.TYPE_REFERENCE:\n\t\t\treturn FETCH_DELAY_REFERENCE_TYPE;\n\t\tdefault:\n\t\t\treturn 0;\n\t}\n}\n\n/**\n * Represents Page Previews fetching data via the gateway.\n *\n * @param {Gateway} gateway\n * @param {mw.Title} title\n * @param {Element} el\n * @param {string} token The unique token representing the link interaction that\n *  triggered the fetch\n * @param {string} type\n * @return {Redux.Thunk}\n */\nexport function fetch( gateway, title, el, token, type ) {\n\tconst titleText = title.getPrefixedDb(),\n\t\tnamespaceId = title.namespace;\n\n\treturn ( dispatch ) => {\n\t\tconst xhr = gateway.fetchPreviewForTitle( title, el );\n\n\t\tdispatch( timedAction( {\n\t\t\ttype: types.FETCH_START,\n\t\t\tel,\n\t\t\ttitle: titleText,\n\t\t\tnamespaceId,\n\t\t\tpromise: xhr\n\t\t} ) );\n\n\t\tconst chain = xhr\n\t\t\t.then( ( result ) => {\n\t\t\t\tdispatch( timedAction( {\n\t\t\t\t\ttype: types.FETCH_END,\n\t\t\t\t\tel\n\t\t\t\t} ) );\n\n\t\t\t\treturn result;\n\t\t\t} )\n\t\t\t.catch( ( err, data ) => {\n\t\t\t\tconst exception = new Error( err );\n\t\t\t\tconst fetchType = data && data.textStatus && data.textStatus === 'abort' ?\n\t\t\t\t\ttypes.FETCH_ABORTED : types.FETCH_FAILED;\n\n\t\t\t\texception.data = data;\n\t\t\t\tdispatch( {\n\t\t\t\t\ttype: fetchType,\n\t\t\t\t\tel,\n\t\t\t\t\ttoken\n\t\t\t\t} );\n\t\t\t\t// Keep the request promise in a rejected status since it failed.\n\t\t\t\tthrow exception;\n\t\t\t} );\n\n\t\treturn $.when(\n\t\t\tchain,\n\t\t\twait( getDwellDelay( type ) )\n\t\t)\n\t\t\t.then( ( result ) => {\n\t\t\t\tdispatch( {\n\t\t\t\t\ttype: types.FETCH_COMPLETE,\n\t\t\t\t\tel,\n\t\t\t\t\tresult,\n\t\t\t\t\ttoken\n\t\t\t\t} );\n\t\t\t} )\n\t\t\t.catch( ( ex ) => {\n\t\t\t\tconst result = ex.data;\n\t\t\t\tlet showNullPreview = true;\n\t\t\t\t// All failures, except those due to being offline or network error,\n\t\t\t\t// should present \"There was an issue displaying this preview\".\n\t\t\t\t// e.g.:\n\t\t\t\t// - Show (timeout): data=\"http\" {xhr: {}, textStatus: \"timeout\",\n\t\t\t\t//   exception: \"timeout\"}\n\t\t\t\t// - Show (bad MW request): data=\"unknown_action\" {error: {}}\n\t\t\t\t// - Show (RB 4xx): data=\"http\" {xhr: {}, textStatus: \"error\",\n\t\t\t\t//   exception: \"Bad Request\"}\n\t\t\t\t// - Show (RB 5xx): data=\"http\" {xhr: {}, textStatus: \"error\",\n\t\t\t\t//   exception: \"Service Unavailable\"}\n\t\t\t\t// - Suppress (offline or network error): data=\"http\"\n\t\t\t\t//   result={xhr: {}, textStatus: \"error\", exception: \"\"}\n\t\t\t\t// - Abort: data=\"http\"\n\t\t\t\t//   result={xhr: {}, textStatus: \"abort\", exception: \"abort\"}\n\n\t\t\t\tif ( result && result.xhr && result.xhr.readyState === 0 ) {\n\t\t\t\t\tconst isNetworkError = result.textStatus === 'error' && result.exception === '';\n\t\t\t\t\tshowNullPreview = !( isNetworkError || result.textStatus === 'abort' );\n\t\t\t\t}\n\n\t\t\t\tif ( showNullPreview ) {\n\t\t\t\t\tdispatch( {\n\t\t\t\t\t\ttype: types.FETCH_COMPLETE,\n\t\t\t\t\t\tel,\n\t\t\t\t\t\tresult: createNullModel( titleText, title.getUrl() ),\n\t\t\t\t\t\ttoken\n\t\t\t\t\t} );\n\t\t\t\t}\n\t\t\t} );\n\t};\n}\n\n/**\n * Represents the user dwelling on a link, either by hovering over it with\n * their mouse or by focussing it using their keyboard or an assistive device.\n *\n * @param {mw.Title} title\n * @param {Element} el\n * @param {ext.popups.PopupTriggerEvent} measurements\n * @param {Gateway} gateway\n * @param {Function} generateToken\n * @param {string} type\n * @return {Redux.Thunk}\n */\nexport function linkDwell( title, el, event, gateway, generateToken, type ) {\n\tconst token = generateToken(),\n\t\ttitleText = title.getPrefixedDb(),\n\t\tnamespaceId = title.namespace;\n\n\treturn ( dispatch, getState ) => {\n\t\tconst promise = wait( FETCH_START_DELAY );\n\t\tconst action = timedAction( {\n\t\t\ttype: types.LINK_DWELL,\n\t\t\tel,\n\t\t\tevent,\n\t\t\ttoken,\n\t\t\ttitle: titleText,\n\t\t\tnamespaceId,\n\t\t\tpromise\n\t\t} );\n\n\t\tdispatch( action );\n\n\t\t// Has the new generated token been accepted?\n\t\tfunction isNewInteraction() {\n\t\t\treturn getState().preview.activeToken === token;\n\t\t}\n\n\t\tif ( !isNewInteraction() ) {\n\t\t\treturn $.Deferred().resolve().promise();\n\t\t}\n\n\t\treturn promise.then( () => {\n\t\t\tconst previewState = getState().preview;\n\n\t\t\tif ( previewState.enabled && isNewInteraction() ) {\n\t\t\t\treturn dispatch( fetch( gateway, title, el, token, type ) );\n\t\t\t}\n\t\t} );\n\t};\n}\n\n/**\n * Represents the user abandoning a link, either by moving their mouse away\n * from it or by shifting focus to another UI element using their keyboard or\n * an assistive device, or abandoning a preview by moving their mouse away\n * from it.\n *\n * @return {Redux.Thunk}\n */\nexport function abandon() {\n\treturn ( dispatch, getState ) => {\n\t\tconst { activeToken: token, promise } = getState().preview;\n\n\t\tif ( !token ) {\n\t\t\treturn $.Deferred().resolve().promise();\n\t\t}\n\n\t\tdispatch( timedAction( {\n\t\t\ttype: types.ABANDON_START,\n\t\t\ttoken\n\t\t} ) );\n\n\t\tif ( 'abort' in promise ) {\n\t\t\t// Immediately request that any outstanding fetch request be abandoned. Do not wait.\n\t\t\tpromise.abort();\n\t\t}\n\n\t\treturn wait( ABANDON_END_DELAY )\n\t\t\t.then( () => {\n\t\t\t\tdispatch( {\n\t\t\t\t\ttype: types.ABANDON_END,\n\t\t\t\t\ttoken\n\t\t\t\t} );\n\t\t\t} );\n\t};\n}\n\n/**\n * Represents the user clicking on a link with their mouse, keyboard, or an\n * assistive device.\n *\n * @param {Element} el\n * @return {Object}\n */\nexport function linkClick( el ) {\n\treturn timedAction( {\n\t\ttype: types.LINK_CLICK,\n\t\tel\n\t} );\n}\n\n/**\n * Represents the user dwelling on a preview with their mouse.\n *\n * @return {Object}\n */\nexport function previewDwell() {\n\treturn {\n\t\ttype: types.PREVIEW_DWELL\n\t};\n}\n\n/**\n * Represents a preview being shown to the user.\n *\n * This action is dispatched by the `./changeListeners/render.js` change\n * listener.\n *\n * @param {string} token\n * @return {Object}\n */\nexport function previewShow( token ) {\n\treturn ( dispatch, getState ) => {\n\t\tdispatch(\n\t\t\ttimedAction( {\n\t\t\t\ttype: types.PREVIEW_SHOW,\n\t\t\t\ttoken\n\t\t\t} )\n\t\t);\n\n\t\treturn wait( PREVIEW_SEEN_DURATION )\n\t\t\t.then( () => {\n\t\t\t\tconst state = getState(),\n\t\t\t\t\tpreview = state.preview,\n\t\t\t\t\tfetchResponse = preview && preview.fetchResponse,\n\t\t\t\t\tcurrentToken = preview && preview.activeToken,\n\t\t\t\t\tvalidType = fetchResponse && [\n\t\t\t\t\t\tpreviewTypes.TYPE_PAGE,\n\t\t\t\t\t\tpreviewTypes.TYPE_DISAMBIGUATION\n\t\t\t\t\t].indexOf( fetchResponse.type ) > -1;\n\n\t\t\t\tif (\n\t\t\t\t\t// Check the pageview can still be associated with original event\n\t\t\t\t\tcurrentToken && currentToken === token &&\n\t\t\t\t\t// and the preview is still active and of type `page`\n\t\t\t\t\tfetchResponse && validType\n\t\t\t\t) {\n\t\t\t\t\tdispatch( {\n\t\t\t\t\t\ttype: types.PREVIEW_SEEN,\n\t\t\t\t\t\ttitle: fetchResponse.title,\n\t\t\t\t\t\tpageId: fetchResponse.pageId,\n\t\t\t\t\t\t// The existing version of summary endpoint does not\n\t\t\t\t\t\t// provide namespace information, but new version\n\t\t\t\t\t\t// will. Given we only show pageviews for main namespace\n\t\t\t\t\t\t// this is hardcoded until the newer version is available.\n\t\t\t\t\t\tnamespace: 0\n\t\t\t\t\t} );\n\t\t\t\t}\n\t\t\t} );\n\t};\n}\n\n/**\n * Represents the situation when a pageview has been logged\n * (see previewShow and PREVIEW_SEEN action type)\n *\n * @return {Object}\n */\nexport function pageviewLogged() {\n\treturn {\n\t\ttype: types.PAGEVIEW_LOGGED\n\t};\n}\n\n/**\n * Represents the user clicking either the \"Enable previews\" footer menu link,\n * or the \"cog\" icon that's present on each preview.\n *\n * @return {Object}\n */\nexport function showSettings() {\n\treturn {\n\t\ttype: types.SETTINGS_SHOW\n\t};\n}\n\n/**\n * Represents the user closing the settings dialog and saving their settings.\n *\n * @return {Object}\n */\nexport function hideSettings() {\n\treturn {\n\t\ttype: types.SETTINGS_HIDE\n\t};\n}\n\n/**\n * Represents the user saving their settings.\n *\n * N.B. This action returns a Redux.Thunk not because it needs to perform\n * asynchronous work, but because it needs to query the global state for the\n * current enabled state. In order to keep the enabled state in a single\n * place (the preview reducer), we query it and dispatch it as `wasEnabled`\n * so that other reducers (like settings) can act on it without having to\n * duplicate the `enabled` state locally.\n * See docs/adr/0003-keep-enabled-state-only-in-preview-reducer.md for more\n * details.\n *\n * @param {boolean} enabled if previews are enabled or not\n * @return {Redux.Thunk}\n */\nexport function saveSettings( enabled ) {\n\treturn ( dispatch, getState ) => {\n\t\tdispatch( {\n\t\t\ttype: types.SETTINGS_CHANGE,\n\t\t\twasEnabled: getState().preview.enabled,\n\t\t\tenabled\n\t\t} );\n\t};\n}\n\n/**\n * Represents the queued event being logged `changeListeners/eventLogging.js`\n * change listener.\n *\n * @param {Object} event\n * @return {Object}\n */\nexport function eventLogged( event ) {\n\treturn {\n\t\ttype: types.EVENT_LOGGED,\n\t\tevent\n\t};\n}\n\n/**\n * Represents the queued statsv event being logged.\n * See `mw.popups.changeListeners.statsv` change listener.\n *\n * @return {Object}\n */\nexport function statsvLogged() {\n\treturn {\n\t\ttype: types.STATSV_LOGGED\n\t};\n}\n","/**\n * @module bracketedPixelRatio\n */\n\n/**\n * Normalizes a user's device pixel ratio to either 1, 1.5, or 2.\n *\n * This is important when the server resizes images on the fly in order to\n * reduce the work it has to do for device pixel ratios that deviate from a\n * set of common ratios.\n *\n * Adapted from mediawiki/core /resources/src/jquery/jquery.hidpi.js\n *\n * @param {number} [dpr=window.devicePixelRatio]\n * @return {number} The bracketed device pixel ratio\n */\nexport default function ( dpr = window.devicePixelRatio ) {\n\tif ( !dpr ) {\n\t\t// Probably legacy browser so assume 1\n\t\treturn 1;\n\t}\n\n\tif ( dpr > 1.5 ) {\n\t\treturn 2;\n\t}\n\n\tif ( dpr > 1 ) {\n\t\treturn 1.5;\n\t}\n\n\treturn 1;\n}\n","/**\n * @module changeListener\n */\n\n/**\n * @typedef {Function} ext.popups.ChangeListener\n * @param {Object} prevState The previous state\n * @param {Object} state The current state\n */\n\n/**\n * Registers a change listener, which is bound to the\n * [store](http://redux.js.org/docs/api/Store.html).\n *\n * A change listener is a function that is only invoked when the state in the\n * [store](http://redux.js.org/docs/api/Store.html) changes. N.B. that there\n * may not be a 1:1 correspondence with actions being dispatched to the store\n * and the state in the store changing.\n *\n * See [Store#subscribe](http://redux.js.org/docs/api/Store.html#subscribe)\n * for more information about what change listeners may and may not do.\n *\n * @param {Redux.Store} store\n * @param {ext.popups.ChangeListener} callback\n * @return {void}\n */\nexport default function registerChangeListener( store, callback ) {\n\t// This function is based on the example in [the documentation for\n\t// Store#subscribe](http://redux.js.org/docs/api/Store.html#subscribe),\n\t// which was written by Dan Abramov.\n\n\tlet state;\n\n\tstore.subscribe( () => {\n\t\tconst prevState = state;\n\n\t\tstate = store.getState();\n\n\t\tif ( prevState !== state ) {\n\t\t\tcallback( prevState, state );\n\t\t}\n\t} );\n}\n","/**\n * @module changeListeners/eventLogging\n */\n\n/**\n * Creates an instance of the event logging change listener.\n *\n * When an event is enqueued it'll be logged using the schema. Since it's the\n * responsibility of Event Logging (and the UA) to deliver logged events,\n * `EVENT_LOGGED` is immediately dispatched rather than waiting for some\n * indicator of completion.\n *\n * @param {Object} boundActions\n * @param {EventTracker} eventLoggingTracker\n * @param {Function} getCurrentTimestamp\n * @return {ext.popups.ChangeListener}\n */\nexport default function eventLogging(\n\tboundActions, eventLoggingTracker, getCurrentTimestamp\n) {\n\treturn ( _, state ) => {\n\t\tconst eventLoggingObj = state.eventLogging;\n\t\tlet event = eventLoggingObj.event;\n\n\t\tif ( !event ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Per https://meta.wikimedia.org/wiki/Schema:Popups, the timestamp\n\t\t// property should be the time at which the event is logged and not the\n\t\t// time at which the interaction started.\n\t\t//\n\t\t// Rightly or wrongly, it's left as an exercise for the analyst to\n\t\t// calculate the time at which the interaction started as part of their\n\t\t// analyses, e.g. https://phabricator.wikimedia.org/T186016#4002923.\n\t\tevent = $.extend( true, {}, eventLoggingObj.baseData, event, {\n\t\t\ttimestamp: getCurrentTimestamp()\n\t\t} );\n\n\t\teventLoggingTracker( 'event.Popups', event );\n\t\t// Dispatch the eventLogged action so that the state tree can be\n\t\t// cleared/updated.\n\t\tboundActions.eventLogged( event );\n\t};\n}\n","/**\n * @module changeListeners/footerLink\n */\n\n/**\n * Creates the link element and appends it to the footer element.\n *\n * The following elements are considered to be the footer element (highest\n * priority to lowest):\n *\n * # `#footer-places`\n * # `#f-list`\n * # The parent element of `#footer li`, which is either an `ol` or `ul`.\n *\n * @return {JQuery} The link element\n */\nfunction createFooterLink() {\n\tconst $link = $( '<li>' ).append(\n\t\t$( '<a>' )\n\t\t\t.attr( 'href', '#' )\n\t\t\t.text( mw.message( 'popups-settings-enable' ).text() )\n\t);\n\n\t// As yet, we don't know whether the link should be visible.\n\t$link.hide();\n\n\t// From https://en.wikipedia.org/wiki/MediaWiki:Gadget-ReferenceTooltips.js,\n\t// which was written by Yair rand <https://en.wikipedia.org/wiki/User:Yair_rand>.\n\t// eslint-disable-next-line no-jquery/no-global-selector\n\tlet $footer = $( '#footer-places, #f-list' );\n\n\tif ( $footer.length === 0 ) {\n\t\t// eslint-disable-next-line no-jquery/no-global-selector\n\t\t$footer = $( '#footer li' ).parent();\n\t}\n\n\t$footer.append( $link );\n\n\treturn $link;\n}\n\n/**\n * Creates an instance of the footer link change listener.\n *\n * The change listener covers the following behaviour:\n *\n * * The \"Enable previews\" link (the \"link\") is appended to the footer menu\n *   (see `createFooterLink` above).\n * * When Page Previews are disabled, then the link is shown; otherwise, the\n *   link is hidden.\n * * When the user clicks the link, then the `showSettings` bound action\n *   creator is called.\n *\n * @param {Object} boundActions\n * @return {ext.popups.ChangeListener}\n */\nexport default function footerLink( boundActions ) {\n\tlet $footerLink;\n\n\treturn ( prevState, state ) => {\n\t\tif ( $footerLink === undefined ) {\n\t\t\t$footerLink = createFooterLink();\n\t\t\t$footerLink.on( 'click', ( e ) => {\n\t\t\t\te.preventDefault();\n\t\t\t\tboundActions.showSettings();\n\t\t\t} );\n\t\t}\n\n\t\tif ( state.settings.shouldShowFooterLink ) {\n\t\t\t$footerLink.show();\n\t\t} else {\n\t\t\t$footerLink.hide();\n\t\t}\n\t};\n}\n","import footerLink from './footerLink';\nimport eventLogging from './eventLogging';\nimport pageviews from './pageviews';\nimport render from './render';\nimport settings from './settings';\nimport statsv from './statsv';\nimport syncUserSettings from './syncUserSettings';\n\nexport default {\n\tfooterLink,\n\teventLogging,\n\tpageviews,\n\trender,\n\tsettings,\n\tstatsv,\n\tsyncUserSettings\n};\n","/**\n * @module changeListeners/pageviews\n */\n\n/**\n * Creates an instance of the pageviews change listener.\n *\n * When a pageview enqueued it'll be logged using the VirtualPageView schema.\n * Note, it's the responsibility of Event Logging (and the UA) to\n * deliver logged events.\n *\n * @param {Object} boundActions\n * @param {EventTracker} pageviewTracker\n * @return {ext.popups.ChangeListener}\n */\nexport default function pageviews(\n\tboundActions, pageviewTracker\n) {\n\treturn ( _, state ) => {\n\t\tlet page;\n\t\tif ( state.pageviews && state.pageviews.pageview && state.pageviews.page ) {\n\t\t\tpage = state.pageviews.page;\n\t\t\tpageviewTracker( 'event.VirtualPageView', $.extend( {},\n\t\t\t\t{\n\t\t\t\t\t/* eslint-disable camelcase */\n\t\t\t\t\tsource_page_id: page.id,\n\t\t\t\t\tsource_namespace: page.namespaceId,\n\t\t\t\t\tsource_title: page.title,\n\t\t\t\t\tsource_url: page.url\n\t\t\t\t\t/* eslint-enable camelcase */\n\t\t\t\t},\n\t\t\t\tstate.pageviews.pageview )\n\t\t\t);\n\t\t\t// Clear the pageview now its been logged.\n\t\t\tboundActions.pageviewLogged();\n\t\t}\n\t};\n}\n","import * as renderer from '../ui/renderer';\n\n/**\n * Creates an instance of the render change listener.\n *\n * FIXME: Remove hard coupling with renderer, inject it as a parameter\n * * Wire it up in index.js\n * * Fix tests to remove require mocking\n *\n * @param {ext.popups.PreviewBehavior} previewBehavior\n * @return {ext.popups.ChangeListener}\n */\nexport default function render( previewBehavior ) {\n\tlet preview;\n\n\treturn ( prevState, state ) => {\n\t\tif ( state.preview.shouldShow && !preview ) {\n\t\t\tpreview = renderer.render( state.preview.fetchResponse );\n\t\t\tpreview.show(\n\t\t\t\tstate.preview.activeEvent,\n\t\t\t\tpreviewBehavior,\n\t\t\t\tstate.preview.activeToken\n\t\t\t);\n\t\t} else if ( !state.preview.shouldShow && preview ) {\n\t\t\tpreview.hide();\n\t\t\tpreview = undefined;\n\t\t}\n\t};\n}\n","/**\n * Creates an instance of the settings change listener.\n *\n * @param {Object} boundActions\n * @param {Object} render function that renders a jQuery el with the settings\n * @return {ext.popups.ChangeListener}\n */\nexport default function settings( boundActions, render ) {\n\tlet settingsObj;\n\n\treturn ( prevState, state ) => {\n\t\tif ( !prevState ) {\n\t\t\t// Nothing to do on initialization\n\t\t\treturn;\n\t\t}\n\n\t\t// Update global modal visibility\n\t\tif (\n\t\t\tprevState.settings.shouldShow === false &&\n\t\t\tstate.settings.shouldShow === true\n\t\t) {\n\t\t\t// Lazily instantiate the settings UI\n\t\t\tif ( !settingsObj ) {\n\t\t\t\tsettingsObj = render( boundActions );\n\t\t\t\tsettingsObj.appendTo( document.body );\n\t\t\t}\n\n\t\t\t// Update the UI settings with the current settings\n\t\t\tsettingsObj.setEnabled( state.preview.enabled );\n\n\t\t\tsettingsObj.show();\n\t\t} else if (\n\t\t\tprevState.settings.shouldShow === true &&\n\t\t\tstate.settings.shouldShow === false\n\t\t) {\n\t\t\tsettingsObj.hide();\n\t\t}\n\n\t\t// Update help visibility\n\t\tif ( prevState.settings.showHelp !== state.settings.showHelp ) {\n\t\t\tsettingsObj.toggleHelp( state.settings.showHelp );\n\t\t}\n\t};\n}\n","/**\n * Creates an instance of the statsv change listener.\n *\n * The listener will log events to StatsD via the [the \"StatsD timers and\n * counters\" analytics event protocol][0].\n *\n * [0]: https://github.com/wikimedia/mediawiki-extensions-WikimediaEvents/blob/29c864a0/modules/ext.wikimediaEvents.statsd.js\n *\n * @param {Object} boundActions\n * @param {EventTracker} track\n * @return {ext.popups.ChangeListener}\n */\nexport default function statsv( boundActions, track ) {\n\treturn ( _, state ) => {\n\t\tconst statsvObj = state.statsv;\n\n\t\tif ( statsvObj.action ) {\n\t\t\ttrack( statsvObj.action, statsvObj.data );\n\n\t\t\tboundActions.statsvLogged();\n\t\t}\n\t};\n}\n","/**\n * @module changeListeners/syncUserSettings\n */\n\n/**\n * Creates an instance of the user settings sync change listener.\n *\n * This change listener syncs certain parts of the state tree to user\n * settings when they change.\n *\n * Used for:\n *\n * * Enabled state: If the previews are enabled or disabled.\n * * Preview count: When the user dwells on a link for long enough that\n *   a preview is shown, then their preview count will be incremented (see\n *   `reducers/eventLogging.js`, and is persisted to local storage.\n *\n * @param {ext.popups.UserSettings} userSettings\n * @return {ext.popups.ChangeListener}\n */\nexport default function syncUserSettings( userSettings ) {\n\treturn ( prevState, state ) => {\n\t\tsyncIfChanged(\n\t\t\tprevState, state, 'eventLogging', 'previewCount',\n\t\t\tuserSettings.setPreviewCount\n\t\t);\n\t\tsyncIfChanged(\n\t\t\tprevState, state, 'preview', 'enabled',\n\t\t\tuserSettings.setIsEnabled\n\t\t);\n\n\t};\n}\n\n/**\n * Given a state tree, reducer and property, safely return the value of the\n * property if the reducer and property exist\n *\n * @param {Object} state tree\n * @param {string} reducer key to access on the state tree\n * @param {string} prop key to access on the reducer key of the state tree\n * @return {*}\n */\nfunction get( state, reducer, prop ) {\n\treturn state[ reducer ] && state[ reducer ][ prop ];\n}\n\n/**\n * Calls a sync function if the property prop on the property reducer on\n * the state trees has changed value.\n *\n * @param {Object} prevState\n * @param {Object} state\n * @param {string} reducer key to access on the state tree\n * @param {string} prop key to access on the reducer key of the state tree\n * @param {Function} sync function to be called with the newest value if\n * changed\n * @return {void}\n */\nfunction syncIfChanged( prevState, state, reducer, prop, sync ) {\n\tconst current = get( state, reducer, prop );\n\tif ( prevState && ( get( prevState, reducer, prop ) !== current ) ) {\n\t\tsync( current );\n\t}\n}\n","import bracketedPixelRatio from './bracketedPixelRatio';\n\nconst bpr = bracketedPixelRatio();\n\nexport default {\n\tBRACKETED_DEVICE_PIXEL_RATIO: bpr,\n\tTHUMBNAIL_SIZE: 320 * bpr,\n\tEXTRACT_LENGTH: 525\n};\n","/**\n * @module counts\n */\n\n/**\n * Gets the count bucket for the number of edits a user has made.\n *\n * The buckets are defined as part of\n * [the Popups schema](https://meta.wikimedia.org/wiki/Schema:Popups).\n *\n * Extracted from `mw.popups.schemaPopups.getEditCountBucket`.\n *\n * @param {number} count\n * @return {string}\n */\nexports.getEditCountBucket = function getEditCountBucket( count ) {\n\tlet bucket;\n\n\tif ( count === 0 ) {\n\t\tbucket = '0';\n\t} else if ( count >= 1 && count <= 4 ) {\n\t\tbucket = '1-4';\n\t} else if ( count >= 5 && count <= 99 ) {\n\t\tbucket = '5-99';\n\t} else if ( count >= 100 && count <= 999 ) {\n\t\tbucket = '100-999';\n\t} else if ( count >= 1000 ) {\n\t\tbucket = '1000+';\n\t}\n\n\treturn `${bucket} edits`;\n};\n\n/**\n * Gets the count bucket for the number of previews a user has seen.\n *\n * If local storage isn't available - because the user has disabled it\n * or the browser doesn't support it - then \"unknown\" is returned.\n *\n * The buckets are defined as part of\n * [the Popups schema](https://meta.wikimedia.org/wiki/Schema:Popups).\n *\n * Extracted from `mw.popups.getPreviewCountBucket`.\n *\n * @param {number|null|string|boolean} [count]\n * @return {string}\n */\nexports.getPreviewCountBucket = function getPreviewCountBucket( count ) {\n\tlet bucket;\n\n\tif ( count === 0 ) {\n\t\tbucket = '0';\n\t} else if ( count >= 1 && count <= 4 ) {\n\t\tbucket = '1-4';\n\t} else if ( count >= 5 && count <= 20 ) {\n\t\tbucket = '5-20';\n\t} else if ( count >= 21 ) {\n\t\tbucket = '21+';\n\t}\n\n\treturn bucket !== undefined ? ( `${bucket} previews` ) : 'unknown';\n};\n","/**\n * @module experiments\n */\n\n/**\n * @interface Experiments\n *\n * @global\n */\n\n/**\n * Creates a helper wrapper for the MediaWiki-provided\n * `mw.experiments#getBucket` bucketing function.\n *\n * @param {mw.experiments} mwExperiments The `mw.experiments` singleton instance\n * @return {Experiments}\n */\nexport default function createExperiments( mwExperiments ) {\n\treturn {\n\t\t/**\n\t\t * Gets whether something is true given a name and a token.\n\t\t *\n\t\t * @example\n\t\t * import createExperiments from './src/experiments';\n\t\t * const experiments = createExperiments( mw.experiments );\n\t\t * const isFooEnabled = experiments.weightedBoolean(\n\t\t *   'foo',\n\t\t *   10 / 100, // 10% of all unique tokens should have foo enabled.\n\t\t *   token\n\t\t * );\n\t\t *\n\t\t * @method\n\t\t * @name Experiments#weightedBoolean\n\t\t * @param {string} name The name of the thing. Since this is used as the\n\t\t *  name of the underlying experiment it should be unique to reduce the\n\t\t *  likelihood of collisions with other enabled experiments\n\t\t * @param {number} trueWeight A number between 0 and 1, representing the\n\t\t *  probability of the thing being true\n\t\t * @param {string} token A token associated with the user for the duration\n\t\t *  of the experiment\n\t\t * @return {boolean}\n\t\t */\n\t\tweightedBoolean( name, trueWeight, token ) {\n\t\t\treturn mwExperiments.getBucket( {\n\t\t\t\tenabled: true,\n\n\t\t\t\tname,\n\t\t\t\tbuckets: {\n\t\t\t\t\ttrue: trueWeight,\n\t\t\t\t\tfalse: 1 - trueWeight\n\t\t\t\t}\n\t\t\t}, token ) === 'true';\n\t\t}\n\t};\n}\n","/**\n * Improves the plain text extracts\n *\n * @param {string} plainTextExtract\n * @param {string} title\n * @return {Array}\n */\nexport function formatPlainTextExtract( plainTextExtract, title ) {\n\tlet extract = plainTextExtract;\n\tif ( plainTextExtract === undefined ) {\n\t\treturn [];\n\t}\n\n\t// After cleaning the extract it may have been blanked\n\tif ( extract.length === 0 ) {\n\t\treturn [];\n\t}\n\n\textract = makeTitleInExtractBold( extract, title );\n\treturn extract;\n}\n\n/**\n * Converts the extract into a list of elements, which correspond to fragments\n * of the extract. Fragments that match the title verbatim are wrapped in a\n * `<b>` element.\n *\n * Using the bolded elements of the extract of the page directly is covered by\n * [T141651](https://phabricator.wikimedia.org/T141651).\n *\n * Extracted from `mw.popups.renderer.article.getProcessedElements`.\n *\n * @param {string} extract\n * @param {string} title\n * @return {Array} A set of HTML Elements\n */\nfunction makeTitleInExtractBold( extract, title ) {\n\tconst elements = [],\n\t\tboldIdentifier = `<bi-${Math.random()}>`,\n\t\tsnip = `<snip-${Math.random()}>`;\n\n\ttitle = title.replace( /\\s+/g, ' ' ).trim(); // Remove extra white spaces\n\tconst escapedTitle = mw.util.escapeRegExp( title );\n\tconst regExp = new RegExp( `(^|\\\\s)(${escapedTitle})(|$)`, 'i' );\n\n\t// Remove text in parentheses along with the parentheses\n\textract = extract.replace( /\\s+/, ' ' ); // Remove extra white spaces\n\n\t// Make title bold in the extract text\n\t// As the extract is html escaped there can be no such string in it\n\t// Also, the title is escaped of RegExp elements thus can't have \"*\"\n\textract = extract.replace(\n\t\tregExp,\n\t\t`$1${snip}${boldIdentifier}$2${snip}$3`\n\t);\n\textract = extract.split( snip );\n\n\textract.forEach( ( part ) => {\n\t\tif ( part.indexOf( boldIdentifier ) === 0 ) {\n\t\t\telements.push( $( '<b>' )\n\t\t\t\t.text( part.substring( boldIdentifier.length ) ) );\n\t\t} else {\n\t\t\telements.push( document.createTextNode( part ) );\n\t\t}\n\t} );\n\n\treturn elements;\n}\n","/**\n * @module gateway/mediawiki\n */\n\nimport { createModel } from '../preview/model';\nimport * as formatter from '../formatter';\n\n// Public and private cache lifetime (5 minutes)\n//\n// FIXME: Move this to src/constants.js.\nconst CACHE_LIFETIME = 300;\n\n/**\n * @typedef {Gateway} MediaWikiGateway\n * @property {function(Object): Object} extractPageFromResponse\n * @property {function(Object): Object} formatPlainTextExtract\n */\n\n/**\n * Creates an instance of the MediaWiki API gateway.\n *\n * @param {mw.Api} api\n * @param {Object} config Configuration that affects the major behavior of the\n *  gateway.\n * @param {number} config.THUMBNAIL_SIZE The length of the major dimension of\n *  the thumbnail.\n * @param {number} config.EXTRACT_LENGTH The maximum length, in characters,\n *  of the extract.\n * @param {string} config.acceptLanguage The accepted language sent in the\n *  header\n * @return {MediaWikiGateway}\n */\nexport default function createMediaWikiApiGateway( api, config ) {\n\tfunction fetch( title ) {\n\t\treturn api.get( {\n\t\t\taction: 'query',\n\t\t\tprop: 'info|extracts|pageimages|revisions|info',\n\t\t\tformatversion: 2,\n\t\t\tredirects: true,\n\t\t\texintro: true,\n\t\t\texchars: config.EXTRACT_LENGTH,\n\n\t\t\t// There is an added geometric limit on .mwe-popups-extract\n\t\t\t// so that text does not overflow from the card.\n\t\t\texplaintext: true,\n\n\t\t\tpiprop: 'thumbnail',\n\t\t\tpithumbsize: config.THUMBNAIL_SIZE,\n\t\t\tpilicense: 'any',\n\t\t\trvprop: 'timestamp',\n\t\t\tinprop: 'url',\n\t\t\ttitles: title,\n\t\t\tsmaxage: CACHE_LIFETIME,\n\t\t\tmaxage: CACHE_LIFETIME,\n\t\t\tuselang: 'content'\n\t\t}, {\n\t\t\theaders: {\n\t\t\t\t'X-Analytics': 'preview=1',\n\t\t\t\t'Accept-Language': config.acceptLanguage\n\t\t\t}\n\t\t} );\n\t}\n\n\t/**\n\t * @param {mw.Title} title\n\t * @return {AbortPromise<PagePreviewModel>}\n\t */\n\tfunction fetchPreviewForTitle( title ) {\n\t\tconst xhr = fetch( title.getPrefixedDb() );\n\t\treturn xhr.then( ( data ) => {\n\t\t\tconst page = extractPageFromResponse( data );\n\t\t\tconst plainTextExtract = formatPlainTextExtract( page );\n\t\t\treturn convertPageToModel( plainTextExtract );\n\t\t} ).promise( {\n\t\t\tabort() {\n\t\t\t\txhr.abort();\n\t\t\t}\n\t\t} );\n\t}\n\n\treturn {\n\t\tfetch,\n\t\textractPageFromResponse,\n\t\tconvertPageToModel,\n\t\tfetchPreviewForTitle,\n\t\tformatPlainTextExtract\n\t};\n}\n\n/**\n * Extracts page data from the API response.\n *\n * @method\n * @name MediaWikiGateway#extractPageFromResponse\n * @param {Object} data The response\n * @throws {Error} If the response is empty or doesn't contain data about the\n *  page\n * @return {Object}\n */\nfunction extractPageFromResponse( data ) {\n\tif (\n\t\tdata.query &&\n\t\tdata.query.pages &&\n\t\tdata.query.pages.length\n\t) {\n\t\treturn data.query.pages[ 0 ];\n\t}\n\n\tthrow new Error( 'API response `query.pages` is empty.' );\n}\n\n/**\n * Make plain text nicer by applying formatter.\n *\n * @method\n * @name MediaWikiGateway#formatPlainTextExtract\n * @param {Object} data The response\n * @return {Object}\n */\nfunction formatPlainTextExtract( data ) {\n\tconst result = $.extend( {}, data );\n\tresult.extract = formatter.formatPlainTextExtract( data.extract, data.title );\n\treturn result;\n}\n\n/**\n * Converts the API response to a preview model.\n *\n * @method\n * @name MediaWikiGateway#convertPageToModel\n * @param {Object} page\n * @return {PagePreviewModel}\n */\nfunction convertPageToModel( page ) {\n\treturn createModel(\n\t\tpage.title,\n\t\tpage.canonicalurl,\n\t\tpage.pagelanguagehtmlcode,\n\t\tpage.pagelanguagedir,\n\t\tpage.extract,\n\t\tpage.type,\n\t\tpage.thumbnail,\n\t\tpage.pageid\n\t);\n}\n","/**\n * @module gateway/page\n */\n\nimport constants from '../constants';\nimport createMediaWikiApiGateway from './mediawiki';\nimport createRESTBaseGateway from './rest';\nimport * as formatters from './restFormatters';\n\n/**\n * Creates a page preview gateway with sensible values for the dependencies.\n *\n * @param {mw.Map} config\n * @return {Gateway}\n */\nexport default function createPagePreviewGateway( config ) {\n\tconst gatewayConfig = $.extend( {}, constants, {\n\t\tacceptLanguage: config.get( 'wgPageContentLanguage' )\n\t} );\n\tconst restConfig = $.extend( {}, gatewayConfig, {\n\t\tendpoint: config.get( 'wgPopupsRestGatewayEndpoint' )\n\t} );\n\tswitch ( config.get( 'wgPopupsGateway' ) ) {\n\t\tcase 'mwApiPlain':\n\t\t\treturn createMediaWikiApiGateway( new mw.Api(), gatewayConfig );\n\t\tcase 'restbasePlain':\n\t\t\treturn createRESTBaseGateway(\n\t\t\t\t$.ajax, restConfig, formatters.parsePlainTextResponse );\n\t\tcase 'restbaseHTML':\n\t\t\treturn createRESTBaseGateway(\n\t\t\t\t$.ajax, restConfig, formatters.parseHTMLResponse );\n\t\tdefault:\n\t\t\tthrow new Error( 'Unknown gateway' );\n\t}\n}\n","/**\n * @module gateway/reference\n */\n\nimport { previewTypes } from '../preview/model';\n\n/**\n * @return {Gateway}\n */\nexport default function createReferenceGateway() {\n\n\tfunction scrapeReferenceText( id ) {\n\t\tconst idSelector = `#${$.escapeSelector( id )}`;\n\n\t\t/**\n\t\t * Same alternative selectors with and without mw- as in the RESTbased endpoint.\n\t\t *\n\t\t * @see https://phabricator.wikimedia.org/diffusion/GMOA/browse/master/lib/transformations/references/structureReferenceListContent.js$138\n\t\t */\n\t\treturn $( `${idSelector} .mw-reference-text, ${idSelector} .reference-text` );\n\t}\n\n\t/**\n\t * This extracts the type (e.g. \"web\") from one or more <cite> elements class name lists, as\n\t * long as these don't conflict. A \"citation\" class is always ignored. <cite> elements without\n\t * another class (other than \"citation\") are ignored as well.\n\t *\n\t * Note this might return multiple types, e.g. <cite class=\"web citation paywalled\"> will be\n\t * returned as \"web paywalled\". Validation must be done in the code consuming this.\n\t *\n\t * This duplicates the strict type detection from\n\t *\n\t * @see https://phabricator.wikimedia.org/diffusion/GMOA/browse/master/lib/transformations/references/structureReferenceListContent.js$93\n\t *\n\t * @param {JQuery} $referenceText\n\t * @return {string|null}\n\t */\n\tfunction scrapeReferenceType( $referenceText ) {\n\t\tlet type = null;\n\n\t\t$referenceText.find( 'cite[class]' ).each( function ( index, el ) {\n\t\t\tconst nextType = el.className.replace( /\\bcitation\\b\\s*/g, '' ).trim();\n\n\t\t\tif ( !type ) {\n\t\t\t\ttype = nextType;\n\t\t\t} else if ( nextType && nextType !== type ) {\n\t\t\t\ttype = null;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} );\n\n\t\treturn type;\n\t}\n\n\t/**\n\t * @param {mw.Title} title\n\t * @param {Element} el\n\t * @return {AbortPromise<ReferencePreviewModel>}\n\t */\n\tfunction fetchPreviewForTitle( title, el ) {\n\t\t// Need to encode the fragment again as mw.Title returns it as decoded text\n\t\tconst id = title.getFragment().replace( / /g, '_' ),\n\t\t\t$referenceText = scrapeReferenceText( id );\n\n\t\tif ( !$referenceText.length ||\n\t\t\t// Skip references that don't contain anything but whitespace, e.g. a single &nbsp;\n\t\t\t( !$referenceText.text().trim() && !$referenceText.children().length )\n\t\t) {\n\t\t\treturn $.Deferred().reject(\n\t\t\t\t'Footnote not found',\n\t\t\t\t// Required to set `showNullPreview` to false and not open an error popup\n\t\t\t\t{ textStatus: 'abort', xhr: { readyState: 0 } }\n\t\t\t).promise( { abort() {} } );\n\t\t}\n\n\t\tconst model = {\n\t\t\turl: `#${id}`,\n\t\t\textract: $referenceText.html(),\n\t\t\ttype: previewTypes.TYPE_REFERENCE,\n\t\t\treferenceType: scrapeReferenceType( $referenceText ),\n\t\t\tsourceElementId: el && el.parentNode && el.parentNode.id\n\t\t};\n\n\t\treturn $.Deferred().resolve( model ).promise( { abort() {} } );\n\t}\n\n\treturn {\n\t\tfetchPreviewForTitle\n\t};\n}\n","/**\n * @module gateway/rest\n */\n\nimport { createModel } from '../preview/model';\n\nconst RESTBASE_PROFILE = 'https://www.mediawiki.org/wiki/Specs/Summary/1.2.0';\n\n/** @typedef {function(JQuery.AjaxSettings=): JQuery.jqXHR} Ajax */\n\n/**\n * Creates an instance of the RESTBase gateway.\n *\n * This gateway differs from the {@link MediaWikiGateway MediaWiki gateway} in\n * that it fetches page data from [the RESTBase page summary endpoint][0].\n *\n * [0]: https://en.wikipedia.org/api/rest_v1/#!/Page_content/get_page_summary_title\n *\n * @param {Ajax} ajax A function with the same signature as `jQuery.ajax`\n * @param {Object} config Configuration that affects the major behavior of the\n *  gateway.\n * @param {Function} extractParser A function that takes response and returns\n *  parsed extract\n * @return {Gateway}\n */\nexport default function createRESTBaseGateway( ajax, config, extractParser ) {\n\t/**\n\t * Fetches page data from [the RESTBase page summary endpoint][0].\n\t *\n\t * [0]: https://en.wikipedia.org/api/rest_v1/#!/Page_content/get_page_summary_title\n\t *\n\t * @method\n\t * @name RESTBaseGateway#fetch\n\t * @param {string} title\n\t * @return {JQuery.jqXHR}\n\t */\n\tfunction fetch( title ) {\n\t\tconst endpoint = config.endpoint;\n\n\t\treturn ajax( {\n\t\t\turl: endpoint + encodeURIComponent( title ),\n\t\t\theaders: {\n\t\t\t\tAccept: `application/json; charset=utf-8; profile=\"${RESTBASE_PROFILE}\"`,\n\t\t\t\t'Accept-Language': config.acceptLanguage\n\t\t\t}\n\t\t} );\n\t}\n\n\t/**\n\t * @param {mw.Title} title\n\t * @return {AbortPromise<PagePreviewModel>}\n\t */\n\tfunction fetchPreviewForTitle( title ) {\n\t\tconst titleText = title.getPrefixedDb(),\n\t\t\txhr = fetch( titleText );\n\t\treturn xhr.then( ( page ) => {\n\t\t\t// Endpoint response may be empty or simply missing a title.\n\t\t\tif ( !page || !page.title ) {\n\t\t\t\tpage = $.extend( true, page || {}, { title: titleText } );\n\t\t\t}\n\t\t\t// And extract may be omitted if empty string\n\t\t\tif ( page.extract === undefined ) {\n\t\t\t\tpage.extract = '';\n\t\t\t}\n\t\t\treturn convertPageToModel(\n\t\t\t\tpage, config.THUMBNAIL_SIZE, extractParser\n\t\t\t);\n\t\t} ).catch( ( jqXHR, textStatus, errorThrown ) => {\n\t\t\t// The client will choose how to handle these errors which may include\n\t\t\t// those due to HTTP 4xx and 5xx status. The rejection typing matches\n\t\t\t// fetch failures.\n\t\t\treturn $.Deferred().reject( 'http', {\n\t\t\t\txhr: jqXHR,\n\t\t\t\ttextStatus,\n\t\t\t\texception: errorThrown\n\t\t\t} );\n\t\t} ).promise( { abort() { xhr.abort(); } } );\n\t}\n\n\treturn {\n\t\tfetch,\n\t\tconvertPageToModel,\n\t\tfetchPreviewForTitle\n\t};\n}\n\n/**\n * Checks whether the `originalImage` property contains an image\n * format that's safe to render.\n * https://www.mediawiki.org/wiki/Help:Images#Supported_media_types_for_images\n *\n * @param {string} filename\n *\n * @return {boolean}\n */\nfunction isSafeImgFormat( filename ) {\n\tconst safeImage = new RegExp( /\\.(jpg|jpeg|png|gif)$/i );\n\treturn safeImage.test( filename );\n}\n\n/**\n * Resizes the thumbnail to the requested width, preserving its aspect ratio.\n *\n * The requested width is limited to that of the original image unless the image\n * is an SVG, which can be scaled infinitely.\n *\n * This function is only intended to mangle the pretty thumbnail URLs used on\n * Wikimedia Commons. Once [an official thumb API](https://phabricator.wikimedia.org/T66214)\n * is fully specified and implemented, this function can be made more general.\n *\n * @param {Object} thumbnail The thumbnail image\n * @param {Object} original The original image\n * @param {number} thumbSize The requested size\n * @return {{source: string, width: number, height: number}|undefined}\n */\nfunction generateThumbnailData( thumbnail, original, thumbSize ) {\n\tconst parts = thumbnail.source.split( '/' ),\n\t\tlastPart = parts[ parts.length - 1 ],\n\t\toriginalIsSafe = isSafeImgFormat( original.source ) || undefined;\n\n\t// The last part, the thumbnail's full filename, is in the following form:\n\t// ${width}px-${filename}.${extension}. Splitting the thumbnail's filename\n\t// makes this function resilient to the thumbnail not having the same\n\t// extension as the original image, which is definitely the case for SVG's\n\t// where the thumbnail's extension is .svg.png.\n\tconst filenamePxIndex = lastPart.indexOf( 'px-' );\n\tif ( filenamePxIndex === -1 ) {\n\t\t// The thumbnail size is not customizable. Presumably, RESTBase requested a\n\t\t// width greater than the original and so MediaWiki returned the original's\n\t\t// URL instead of a thumbnail compatible URL. An original URL does not have\n\t\t// a \"thumb\" path, e.g.:\n\t\t//\n\t\t//   https://upload.wikimedia.org/wikipedia/commons/a/aa/Red_Giant_Earth_warm.jpg\n\t\t//\n\t\t// Instead of:\n\t\t//\n\t\t//   https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Red_Giant_Earth_warm.jpg/512px-Red_Giant_Earth_warm.jpg\n\t\t//\n\t\t// Use the original if it's a supported image format.\n\t\treturn originalIsSafe && original;\n\t}\n\tconst filename = lastPart.substr( filenamePxIndex + 3 );\n\n\t// Scale the thumbnail's largest dimension.\n\tlet width, height;\n\tif ( thumbnail.width > thumbnail.height ) {\n\t\twidth = thumbSize;\n\t\theight = Math.floor( ( thumbSize / thumbnail.width ) * thumbnail.height );\n\t} else {\n\t\twidth = Math.floor( ( thumbSize / thumbnail.height ) * thumbnail.width );\n\t\theight = thumbSize;\n\t}\n\n\t// If the image isn't an SVG, then it shouldn't be scaled past its original\n\t// dimensions.\n\tif ( width >= original.width && filename.indexOf( '.svg' ) === -1 ) {\n\t\t// if the image format is not supported, it shouldn't be rendered.\n\t\treturn originalIsSafe && original;\n\t}\n\n\tparts[ parts.length - 1 ] = `${width}px-${filename}`;\n\n\treturn {\n\t\tsource: parts.join( '/' ),\n\t\twidth,\n\t\theight\n\t};\n}\n\n/**\n * Converts the API response to a preview model.\n *\n * @method\n * @name RESTBaseGateway#convertPageToModel\n * @param {Object} page\n * @param {number} thumbSize\n * @param {Function} extractParser\n * @return {PagePreviewModel}\n */\nexport function convertPageToModel( page, thumbSize, extractParser ) {\n\treturn createModel(\n\t\tpage.title,\n\t\tnew mw.Title( page.title ).getUrl(),\n\t\tpage.lang,\n\t\tpage.dir,\n\t\textractParser( page ),\n\t\tpage.type,\n\t\tpage.thumbnail ?\n\t\t\tgenerateThumbnailData(\n\t\t\t\tpage.thumbnail, page.originalimage, thumbSize\n\t\t\t) : undefined,\n\t\tpage.pageid\n\t);\n}\n","import * as formatter from '../formatter';\n\n/**\n * Prepare extract\n *\n * @param {Object} page Rest response\n * @return {Array} An array of DOM Elements\n */\nexport function parseHTMLResponse( page ) {\n\tconst extract = page.extract_html;\n\n\treturn extract.length === 0 ? [] : $.parseHTML( extract );\n}\n\n/**\n * Prepare extract\n *\n * @param {Object} page Rest response\n * @return {Array} An array of DOM Elements\n */\nexport function parsePlainTextResponse( page ) {\n\treturn formatter.formatPlainTextExtract( page.extract, page.title );\n}\n","/**\n * @module getPageviewTracker\n */\n\n/**\n * @typedef {Object} MwCodeLoader\n *\n * Loads code from the server to the client on demand.\n *\n * @param {Array} dependencies to load\n * @return {JQuery.Deferred} resolving when the code is loaded and\n *   can be used by the client.\n *\n * @global\n */\n\n/**\n * Convert the first letter of a string to uppercase.\n *\n * @param {string} word\n * @return {string}\n */\nfunction titleCase( word ) {\n\treturn word[ 0 ].toUpperCase() + word.slice( 1 );\n}\n\n/**\n * Truncates a string to a maximum length based on its URI encoded value.\n *\n * @param {string} sourceUrl source string\n * @param {number} maxLength maximum length\n * @return {string} string is returned in the same encoding as the input\n */\nfunction limitByEncodedURILength( sourceUrl, maxLength ) {\n\tlet truncatedUrl = '';\n\n\tsourceUrl.split( '' ).every( ( char ) => {\n\t\treturn ( encodeURIComponent( truncatedUrl + char ).length < maxLength ) ?\n\t\t\t( truncatedUrl += char ) :\n\t\t\tfalse;\n\t} );\n\treturn truncatedUrl;\n}\n\n/**\n * Convert Title properties into mediawiki canonical form\n * and limit the length of source_url.\n *\n * @param {Object} eventData\n * @return {Object}\n */\nfunction prepareEventData( eventData ) {\n\tconst data = eventData;\n\t/* eslint-disable camelcase */\n\tdata.source_title = mw.Title.newFromText( eventData.source_title )\n\t\t.getPrefixedDb();\n\tdata.page_title = mw.Title.newFromText( eventData.page_title )\n\t\t.getPrefixedDb();\n\t// prevent source_url from exceeding varnish max-url size - T196904\n\tdata.source_url = limitByEncodedURILength( eventData.source_url, 1000 );\n\n\t/* eslint-enable camelcase */\n\treturn data;\n}\n\n/**\n * Gets the appropriate analytics event tracker for logging virtual pageviews.\n * Note this bypasses EventLogging in order to track virtual pageviews\n * for pages where the DNT header (do not track) has been added.\n * This is explained in https://phabricator.wikimedia.org/T187277.\n *\n * @param {Object} config\n * @param {MwCodeLoader} loader that can source code that obeys the\n *  EventLogging api specification.\n * @param {Function} trackerGetter when called returns an instance\n *  of MediaWiki's EventLogging client\n * @param {Function} sendBeacon see\n *  https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon\n * @return {EventTracker}\n */\nfunction getPageviewTracker( config, loader, trackerGetter, sendBeacon ) {\n\tconst pageviewTracker = function ( topic, eventData ) {\n\t\tconst schema = titleCase( topic.slice( topic.indexOf( '.' ) + 1 ) );\n\t\tconst dependencies = [ 'ext.eventLogging' ];\n\t\treturn loader( dependencies ).then( function () {\n\t\t\tconst evLog = trackerGetter();\n\t\t\tconst payload = evLog.prepare( schema, prepareEventData( eventData ) );\n\t\t\tconst url = evLog.makeBeaconUrl( payload );\n\t\t\tsendBeacon( url );\n\t\t} );\n\t};\n\treturn config.get( 'wgPopupsVirtualPageViews' ) ? pageviewTracker : () => {};\n}\n\n/**\n * Gets a function that can asynchronously transfer a small amount of data\n * over HTTP to a web server.\n *\n * @param {Window.Navigator} navigatorObj\n * @return {Function}\n */\nfunction getSendBeacon( navigatorObj ) {\n\treturn navigatorObj.sendBeacon ?\n\t\tnavigatorObj.sendBeacon.bind( navigatorObj ) :\n\t\t( url ) => {\n\t\t\tdocument.createElement( 'img' ).src = url;\n\t\t};\n}\n\nexport { getSendBeacon, limitByEncodedURILength };\nexport default getPageviewTracker;\n","/**\n * @module popups\n */\n\nimport * as Redux from 'redux';\nimport * as ReduxThunk from 'redux-thunk';\n\nimport createPagePreviewGateway from './gateway/page';\nimport createReferenceGateway from './gateway/reference';\nimport createUserSettings from './userSettings';\nimport createPreviewBehavior from './previewBehavior';\nimport createSettingsDialogRenderer from './ui/settingsDialogRenderer';\nimport registerChangeListener from './changeListener';\nimport createIsEnabled from './isEnabled';\nimport { fromElement as titleFromElement } from './title';\nimport { init as rendererInit } from './ui/renderer';\nimport createExperiments from './experiments';\nimport { isEnabled as isStatsvEnabled } from './instrumentation/statsv';\nimport { isEnabled as isEventLoggingEnabled }\n\tfrom './instrumentation/eventLogging';\nimport changeListeners from './changeListeners';\nimport * as actions from './actions';\nimport reducers from './reducers';\nimport createMediaWikiPopupsObject from './integrations/mwpopups';\nimport getPageviewTracker, { getSendBeacon } from './getPageviewTracker';\nimport { previewTypes, getPreviewType } from './preview/model';\n\nconst EXCLUDED_LINK_SELECTORS = [\n\t'.extiw',\n\t'.image',\n\t'.new',\n\t'.internal',\n\t'.external',\n\t'.mw-cite-backlink a',\n\t'.oo-ui-buttonedElement-button',\n\t'.ve-ce-surface a', // T259889\n\t'.cancelLink a'\n];\n\n/**\n * @typedef {Function} EventTracker\n *\n * An analytics event tracker, i.e. `mw.track`.\n *\n * @param {string} topic\n * @param {Object} data\n *\n * @global\n */\n\n/**\n * Gets the appropriate analytics event tracker for logging metrics to StatsD\n * via [the \"StatsD timers and counters\" analytics event protocol][0].\n *\n * If logging metrics to StatsD is enabled for the duration of the user's\n * session, then the appriopriate function is `mw.track`; otherwise it's\n * `() => {}`.\n *\n * [0]: https://github.com/wikimedia/mediawiki-extensions-WikimediaEvents/blob/29c864a0/modules/ext.wikimediaEvents.statsd.js\n *\n * @param {Object} user\n * @param {Object} config\n * @param {Experiments} experiments\n * @return {EventTracker}\n */\nfunction getStatsvTracker( user, config, experiments ) {\n\treturn isStatsvEnabled( user, config, experiments ) ? mw.track : () => {};\n}\n\n/**\n * Gets the appropriate analytics event tracker for logging EventLogging events\n * via [the \"EventLogging subscriber\" analytics event protocol][0].\n *\n * If logging EventLogging events is enabled for the duration of the user's\n * session, then the appriopriate function is `mw.track`; otherwise it's\n * `() => {}`.\n *\n * [0]: https://github.com/wikimedia/mediawiki-extensions-EventLogging/blob/d1409759/modules/ext.eventLogging.subscriber.js\n *\n * @param {Object} user\n * @param {Object} config\n * @param {Window} window\n * @return {EventTracker}\n */\nfunction getEventLoggingTracker( user, config, window ) {\n\treturn isEventLoggingEnabled(\n\t\tuser,\n\t\tconfig,\n\t\twindow\n\t) ? mw.track : () => {};\n}\n\n/**\n * Returns timestamp since the beginning of the current document's origin\n * as reported by `window.performance.now()`. See\n * https://developer.mozilla.org/en-US/docs/Web/API/DOMHighResTimeStamp#The_time_origin\n * for a detailed explanation of the time origin.\n *\n * The value returned by this function is used for [the `timestamp` property\n * of the Schema:Popups events sent by the EventLogging\n * instrumentation](./src/changeListeners/eventLogging.js).\n *\n * @return {number|null}\n */\nfunction getCurrentTimestamp() {\n\tif ( window.performance && window.performance.now ) {\n\t\t// return an integer; see T182000\n\t\treturn Math.round( window.performance.now() );\n\t}\n\treturn null;\n}\n\n/**\n * Subscribes the registered change listeners to the\n * [store](http://redux.js.org/docs/api/Store.html#store).\n *\n * @param {Redux.Store} store\n * @param {Object} registerActions\n * @param {UserSettings} userSettings\n * @param {Function} settingsDialog\n * @param {PreviewBehavior} previewBehavior\n * @param {EventTracker} statsvTracker\n * @param {EventTracker} eventLoggingTracker\n * @param {EventTracker} pageviewTracker\n * @param {Function} callbackCurrentTimestamp\n * @return {void}\n */\nfunction registerChangeListeners(\n\tstore, registerActions, userSettings, settingsDialog, previewBehavior,\n\tstatsvTracker, eventLoggingTracker, pageviewTracker, callbackCurrentTimestamp\n) {\n\tregisterChangeListener( store, changeListeners.footerLink( actions ) );\n\tregisterChangeListener( store, changeListeners.render( previewBehavior ) );\n\tregisterChangeListener(\n\t\tstore, changeListeners.statsv( registerActions, statsvTracker ) );\n\tregisterChangeListener(\n\t\tstore, changeListeners.syncUserSettings( userSettings ) );\n\tregisterChangeListener(\n\t\tstore, changeListeners.settings( registerActions, settingsDialog ) );\n\tregisterChangeListener(\n\t\tstore,\n\t\tchangeListeners.eventLogging(\n\t\t\tregisterActions, eventLoggingTracker, callbackCurrentTimestamp\n\t\t) );\n\tregisterChangeListener( store,\n\t\tchangeListeners.pageviews( registerActions, pageviewTracker )\n\t);\n}\n\n/*\n * Initialize the application by:\n * 1. Initializing side-effects and \"services\"\n * 2. Creating the state store\n * 3. Binding the actions to such store\n * 4. Registering change listeners\n * 5. Triggering the boot action to bootstrap the system\n * 6. When the page content is ready:\n *   - Initializing the renderer\n *   - Binding hover and click events to the eligible links to trigger actions\n */\n( function init() {\n\tlet compose = Redux.compose;\n\tconst\n\t\t// So-called \"services\".\n\t\tgenerateToken = mw.user.generateRandomSessionId,\n\t\tpagePreviewGateway = createPagePreviewGateway( mw.config ),\n\t\treferenceGateway = createReferenceGateway(),\n\t\tuserSettings = createUserSettings( mw.storage ),\n\t\tsettingsDialog = createSettingsDialogRenderer(),\n\t\texperiments = createExperiments( mw.experiments ),\n\t\tstatsvTracker = getStatsvTracker( mw.user, mw.config, experiments ),\n\t\t// Virtual pageviews are always tracked.\n\t\tpageviewTracker = getPageviewTracker( mw.config,\n\t\t\tmw.loader.using,\n\t\t\t() => mw.eventLog,\n\t\t\tgetSendBeacon( window.navigator )\n\t\t),\n\t\teventLoggingTracker = getEventLoggingTracker(\n\t\t\tmw.user,\n\t\t\tmw.config,\n\t\t\twindow\n\t\t),\n\t\tisEnabled = createIsEnabled( mw.user, userSettings, mw.config );\n\n\t// If debug mode is enabled, then enable Redux DevTools.\n\tif ( mw.config.get( 'debug' ) === true ||\n\t\t/* global process */\n\t\tprocess.env.NODE_ENV !== 'production' ) {\n\t\t// eslint-disable-next-line no-underscore-dangle\n\t\tcompose = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;\n\t}\n\n\tconst store = Redux.createStore(\n\t\tRedux.combineReducers( reducers ),\n\t\tcompose( Redux.applyMiddleware(\n\t\t\tReduxThunk.default\n\t\t) )\n\t);\n\tconst boundActions = Redux.bindActionCreators( actions, store.dispatch );\n\tconst previewBehavior = createPreviewBehavior( mw.user, boundActions );\n\n\tregisterChangeListeners(\n\t\tstore, boundActions, userSettings, settingsDialog,\n\t\tpreviewBehavior, statsvTracker, eventLoggingTracker,\n\t\tpageviewTracker,\n\t\tgetCurrentTimestamp\n\t);\n\n\tboundActions.boot(\n\t\tisEnabled,\n\t\tmw.user,\n\t\tuserSettings,\n\t\tmw.config,\n\t\twindow.location.href\n\t);\n\n\t/*\n\t * Register external interface exposing popups internals so that other\n\t * extensions can query it (T171287)\n\t */\n\tmw.popups = createMediaWikiPopupsObject( store );\n\n\tconst selectors = [];\n\tif ( mw.user.isAnon() || mw.user.options.get( 'popups' ) === '1' ) {\n\t\tselectors.push( `#mw-content-text a[href][title]:not(${excludedLinksSelector})` );\n\t}\n\t// TODO: Replace with mw.user.options.get( 'popupsreferencepreviews' ) === '1' when not in Beta\n\t// any more, and the temporary feature flag is not needed any more.\n\tif ( mw.config.get( 'wgPopupsReferencePreviews' ) &&\n\t\t// T243822: Temporarily disabled in the mobile skin\n\t\tmw.config.get( 'skin' ) !== 'minerva'\n\t) {\n\t\tselectors.push( '#mw-content-text .reference a[ href*=\"#\" ]' );\n\t}\n\tif ( !selectors.length ) {\n\t\tmw.log.error( 'ext.popups should not even be loaded!' );\n\t\treturn;\n\t}\n\tconst validLinkSelector = selectors.join( ', ' );\n\n\trendererInit();\n\n\tconst eligibleElements = document.querySelectorAll( validLinkSelector );\n\tconst excludedLinksSelector = EXCLUDED_LINK_SELECTORS.join( ', ' );\n\n\tconst addPopupEventHandlers = target => {\n\t\t// Disable default browser tooltip\n\t\tlet gateway\n\t\tlet type\n\t\tconst mwTitle = titleFromElement( target, mw.config );\n\t\tif ( !mwTitle )\n\t\t\treturn;\n\n\t\ttarget.removeAttribute('title');\n\t\tconst gateways = {\n\t\t\t[previewTypes.TYPE_PAGE]: pagePreviewGateway,\n\t\t\t[previewTypes.TYPE_REFERENCE]: referenceGateway\n\t\t}\n\n\t\tconst showPopup = ({clientX, clientY, clientRect, eventType}) => {\n\t\t\tif (gateway === null) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (typeof gateway === 'undefined' ) {\n\t\t\t\ttype = getPreviewType( target, mw.config, mwTitle );\n\t\t\t\tgateway = gateways[type] || null;\n\t\t\t\tif (!gateway) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst event = {eventType, target, clientX, clientY, clientRect, pageXOffset, pageYOffset, innerWidth, innerHeight};\n\t\t\tboundActions.linkDwell( mwTitle, target, event, gateway, generateToken, type );\t\t\t\n\t\t};\n\n\t\tconst hidePopup = () =>  boundActions.abandon();\n\n\t\tconst getNearestClientRect = (rects, y) => \n\t\t\trects.length === 1 ? rects[0] : Array.from(rects).reduce((result, rect) => {\n\t\t\t\tconst deltaY = Math.abs(y - rect.top + y - rect.bottom);\n\t\t\t\treturn result.deltaY < deltaY ? result : {rect, deltaY};\n\t\t\t}, {rect: null, deltaY: Number.MAX_VALUE}).rect;\n\n\t\ttarget.addEventListener('mouseover', event => {\n\t\t\tconst maxLinkWidthForCenteredPointer = 28; // Link with roughly < 4 chars.\n\t\t\tconst {clientY} = event;\n\t\t\tconst clientRects = target.getClientRects();\n\t\t\tconst clientRect = getNearestClientRect(clientRects, clientY);\n\t\t\tconst clientX = (clientRect.width > maxLinkWidthForCenteredPointer) ? event.clientX : (clientRect.left + targetRect.width / 2);\n\n\t\t\tshowPopup({\n\t\t\t\teventType: 'mouse',\n\t\t\t\tclientX, clientY, clientRect,\n\t\t\t\tpageXOffset, pageYOffset\n\t\t\t});\n\t\t});\n\n\t\ttarget.addEventListener( 'keyup', event => {\n\t\t\tconst {target} = event;\n\t\t\tconst [clientRect] = target.getClientRects();\n\t\t\tshowPopup({\n\t\t\t\teventType: 'key',\n\t\t\t\tclientX: clientRect.left,\n\t\t\t\tclientY: clientRect.top + clientRect.height / 2,\n\t\t\t\tclientRect,\n\t\t\t\tpageXOffset, pageYOffset\n\t\t\t});\n\t\t});\n\n\t\ttarget.addEventListener( 'blur', hidePopup );\n\t\ttarget.addEventListener( 'mouseout', hidePopup );\n\t\ttarget.addEventListener( 'click', event => {\n\t\t\tif ( previewTypes.TYPE_PAGE === (type || getPreviewType( target, mw.config, mwTitle ) )) {\n\t\t\t\tboundActions.linkClick( target );\n\t\t\t}\n\t\t} );\n\t}\n\n\tArray.from( eligibleElements )\n\t\t.filter( element => !element.matches(excludedLinksSelector) )\n\t\t.forEach( addPopupEventHandlers )\n}() );\n\nwindow.Redux = Redux;\nwindow.ReduxThunk = ReduxThunk;\n","/**\n * @module instrumentation/eventLogging\n */\n\n/**\n * Gets whether EventLogging logging is enabled for the duration of the user's\n * session.\n * If wgPopupsEventLogging is false this will return false unless debug=true has\n * been enabled.\n * However, if the UA doesn't support [the Beacon API][1], then bucketing is\n * disabled.\n *\n * [1]: https://w3c.github.io/beacon/\n *\n * @param {mw.user} user The `mw.user` singleton instance\n * @param {mw.Map} config The `mw.config` singleton instance\n * @param {Window} window\n * @return {boolean}\n */\nexport function isEnabled( user, config, window ) {\n\t// if debug mode is on, always enable event logging. @see T168847\n\tif ( config.get( 'debug' ) === true ) {\n\t\treturn true;\n\t}\n\n\treturn config.get( 'wgPopupsEventLogging' ) &&\n\t\twindow.navigator &&\n\t\ttypeof window.navigator.sendBeacon === 'function';\n}\n","/**\n * @module instrumentation/statsv\n */\n\n/**\n * Gets whether Graphite logging (via [the statsv HTTP endpoint][0]) is enabled\n * for the duration of the user's session. The bucketing rate is controlled by\n * `wgPopupsStatsvSamplingRate`.\n *\n * [0]: https://wikitech.wikimedia.org/wiki/Graphite#statsv\n *\n * @param {mw.user} user The `mw.user` singleton instance\n * @param {mw.Map} config The `mw.config` singleton instance\n * @param {Experiments} experiments\n * @return {boolean}\n */\nexport function isEnabled( user, config, experiments ) {\n\tconst bucketingRate = config.get( 'wgPopupsStatsvSamplingRate', 0 );\n\n\treturn experiments.weightedBoolean(\n\t\t'ext.Popups.statsv',\n\t\tbucketingRate,\n\t\tuser.sessionId()\n\t);\n}\n","/**\n * @module MediaWiki-Popups Integration\n */\n\n/**\n * This function provides a mw.popups object which can be used by 3rd party\n * to interact with Popups. Currently it allows only to read isEnabled flag.\n *\n * @param {Redux.Store} store Popups store\n * @return {Object} external Popups interface\n */\nexport default function createMwPopups( store ) {\n\treturn {\n\t\tisEnabled: function isEnabled() {\n\t\t\treturn store.getState().preview.enabled;\n\t\t}\n\t};\n\n}\n","/**\n * @module isEnabled\n */\n\n/**\n * Given the global state of the application, creates a function that gets\n * whether or not the user should have Page Previews enabled.\n *\n * Page Previews is disabled when the Navigation Popups gadget is enabled.\n *\n * If Page Previews is configured as a user preference, then the user must\n * either be logged in and have enabled the preference or be logged out and have\n * not disabled previews via the settings modal.\n *\n * @param {mw.user} user The `mw.user` singleton instance\n * @param {Object} userSettings An object returned by `userSettings.js`\n * @param {mw.Map} config\n *\n * @return {boolean}\n */\nexport default function isEnabled( user, userSettings, config ) {\n\tif ( config.get( 'wgPopupsConflictsWithNavPopupGadget' ) ) {\n\t\treturn false;\n\t}\n\n\tif ( !user.isAnon() ) {\n\t\t// For logged-in users, enablement is equal to the\n\t\t// loading of this very code.\n\t\treturn true;\n\t} else {\n\t\t// For anonymous users, the code loads always, but the feature\n\t\t// can be toggled at run-time via local storage.\n\t\tif ( !userSettings.hasIsEnabled() ) {\n\t\t\t// Default when no setting is stored.\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn userSettings.getIsEnabled();\n\t\t}\n\t}\n}\n","/**\n * @module preview/model\n */\n\n/**\n * Page Preview types as defined in Schema:Popups\n * https://meta.wikimedia.org/wiki/Schema:Popups\n *\n * @constant {Object}\n */\nconst previewTypes = {\n\t/** Empty preview used in error situations */\n\tTYPE_GENERIC: 'generic',\n\t/** Standard page preview with or without thumbnail */\n\tTYPE_PAGE: 'page',\n\t/** Disambiguation page preview */\n\tTYPE_DISAMBIGUATION: 'disambiguation',\n\t/** Reference preview **/\n\tTYPE_REFERENCE: 'reference'\n};\n\nexport { previewTypes };\n\n/**\n * Preview Model\n *\n * @typedef {Object} PreviewModel\n * @property {string} url The canonical URL of the page being previewed\n * @property {string} type One of the previewTypes.TYPE_ constants.\n *\n * @global\n */\n\n/**\n * @typedef {Object} PagePreviewModel\n * @extends PreviewModel\n * @property {string} title\n * @property {Array|undefined} extract `undefined` if the extract isn't\n *  viable, e.g. if it's empty after having ellipsis and parentheticals\n *  removed; this can be used to present default or error states\n * @property {string} languageCode\n * @property {string} languageDirection Either \"ltr\" or \"rtl\", or an empty string if undefined.\n * @property {{source: string, width: number, height: number}|undefined} thumbnail\n * @property {number} pageId Currently not used by any known popup type.\n *\n * @global\n */\n\n/**\n * @typedef {Object} ReferencePreviewModel\n * @extends PreviewModel\n * @property {string} extract An HTML snippet, not necessarily with a single top-level node\n * @property {string} referenceType A type identifier, e.g. \"web\"\n * @property {string} sourceElementId ID of the parent element that triggered the preview\n *\n * @global\n */\n\n/**\n * Creates a page preview model.\n *\n * @param {string} title\n * @param {string} url The canonical URL of the page being previewed\n * @param {string} languageCode\n * @param {string} languageDirection Either \"ltr\" or \"rtl\"\n * @param {Array|undefined|null} extract\n * @param {string} type\n * @param {{source: string, width: number, height: number}|undefined} [thumbnail]\n * @param {number} [pageId]\n * @return {PagePreviewModel}\n */\nexport function createModel(\n\ttitle,\n\turl,\n\tlanguageCode,\n\tlanguageDirection,\n\textract,\n\ttype,\n\tthumbnail,\n\tpageId\n) {\n\tconst processedExtract = processExtract( extract ),\n\t\tpreviewType = getPagePreviewType( type, processedExtract );\n\n\treturn {\n\t\ttitle,\n\t\turl,\n\t\tlanguageCode,\n\t\tlanguageDirection,\n\t\textract: processedExtract,\n\t\ttype: previewType,\n\t\tthumbnail,\n\t\tpageId\n\t};\n}\n\n/**\n * Creates an empty page preview model.\n *\n * @param {string} title\n * @param {string} url\n * @return {PagePreviewModel}\n */\nexport function createNullModel( title, url ) {\n\treturn createModel( title, url, '', '', [], '' );\n}\n\n/**\n * Determines the applicable popup type based on title and link element.\n *\n * @param {Element} el\n * @param {mw.Map} config\n * @param {mw.Title} title\n * @return {string|null}\n */\nexport function getPreviewType( el, config, title ) {\n\tif ( !isSelfLink( title, config ) ) {\n\t\treturn previewTypes.TYPE_PAGE;\n\t}\n\n\t// The other selector can potentially pick up self-links with a class=\"reference\"\n\t// parent, but no fragment\n\tif ( title.getFragment() &&\n\t\tconfig.get( 'wgPopupsReferencePreviews' ) &&\n\t\t// eslint-disable-next-line no-jquery/no-class-state\n\t\t$( el ).parent().hasClass( 'reference' )\n\t) {\n\t\treturn previewTypes.TYPE_REFERENCE;\n\t}\n\n\treturn null;\n}\n\n/**\n * @param {mw.Title} title\n * @param {mw.Map} config\n * @return {boolean} True when the link points to the current page.\n */\nfunction isSelfLink( title, config ) {\n\treturn title.getNamespaceId() === config.get( 'wgNamespaceNumber' ) &&\n\t\ttitle.getMainText() === config.get( 'wgTitle' );\n}\n\n/**\n * Processes the extract returned by the TextExtracts MediaWiki API query\n * module.\n *\n * If the extract is `undefined`, `null`, or empty, then `undefined` is\n * returned.\n *\n * @param {Array|undefined|null} extract\n * @return {Array|undefined} Array when extract is an not empty array, undefined\n *  otherwise\n */\nfunction processExtract( extract ) {\n\tif ( extract === undefined || extract === null || extract.length === 0 ) {\n\t\treturn undefined;\n\t}\n\treturn extract;\n}\n\n/**\n * Determines the page preview type based on whether or not:\n * a. Is the preview empty.\n * b. The preview type matches one of previewTypes.\n * c. Assume standard page preview if both above are false\n *\n * @param {string} type\n * @param {Array|undefined} [processedExtract]\n * @return {string} One of the previewTypes.TYPE_ constants.\n */\n\nfunction getPagePreviewType( type, processedExtract ) {\n\tif ( processedExtract === undefined ) {\n\t\treturn previewTypes.TYPE_GENERIC;\n\t}\n\n\tswitch ( type ) {\n\t\tcase previewTypes.TYPE_GENERIC:\n\t\tcase previewTypes.TYPE_DISAMBIGUATION:\n\t\tcase previewTypes.TYPE_PAGE:\n\t\t\treturn type;\n\t\tdefault:\n\t\t\t/**\n\t\t\t * Assume type=\"page\" if extract exists & not one of previewTypes.\n\t\t\t * Note:\n\t\t\t * - Restbase response includes \"type\" prop but other gateways don't.\n\t\t\t * - event-logging Schema:Popups requires type=\"page\" but restbase\n\t\t\t * provides type=\"standard\". Model must conform to event-logging schema.\n\t\t\t */\n\t\t\treturn previewTypes.TYPE_PAGE;\n\t}\n}\n","/**\n * @module previewBehaviour\n */\n\n/**\n * A collection of event handlers specific to how the user interacts with all\n * previews. The event handlers  are are agnostic to how/when they are bound\n * //but not to what they are bound//, i.e. the showSettings event handler is\n * written to be bound to either an `<a>` or `<button>` element.\n *\n * @typedef {Object} ext.popups.PreviewBehavior\n * @property {string} settingsUrl\n * @property {Function} showSettings\n * @property {Function} previewDwell\n * @property {Function} previewAbandon\n * @property {Function} previewShow\n * @property {Function} click handler for the entire preview\n */\n\n/**\n * Creates an instance of `ext.popups.PreviewBehavior`.\n *\n * If the user is logged out, then clicking the cog should show the settings\n * modal.\n *\n * If the user is logged in, then clicking the cog should send them to the\n * the \"Appearance\" tab otherwise.\n *\n * @param {mw.User} user\n * @param {Object} actions The action creators bound to the Redux store\n * @return {ext.popups.PreviewBehavior}\n */\nexport default function createPreviewBehavior( user, actions ) {\n\tlet settingsUrl, showSettings = () => {};\n\n\tif ( user.isAnon() ) {\n\t\tshowSettings = ( event ) => {\n\t\t\tevent.preventDefault();\n\n\t\t\tactions.showSettings();\n\t\t};\n\t} else {\n\t\tconst rawTitle = 'Special:Preferences#mw-prefsection-rendering';\n\n\t\tsettingsUrl = mw.Title.newFromText( rawTitle )\n\t\t\t.getUrl();\n\t}\n\n\treturn {\n\t\tsettingsUrl,\n\t\tshowSettings,\n\t\tpreviewDwell: actions.previewDwell,\n\t\tpreviewAbandon: actions.abandon,\n\t\tpreviewShow: actions.previewShow,\n\t\tclick: actions.linkClick\n\t};\n}\n","/**\n * @module reducers/eventLogging\n */\n\nimport actionTypes from '../actionTypes';\nimport nextState from './nextState';\nimport * as counts from '../counts';\n\n/**\n * Initialize the data that's shared between all events.\n *\n * @param {Object} bootAction\n * @return {Object}\n */\nfunction getBaseData( bootAction ) {\n\tconst result = {\n\t\tpageTitleSource: bootAction.page.title,\n\t\tnamespaceIdSource: bootAction.page.namespaceId,\n\t\tpageIdSource: bootAction.page.id,\n\t\tisAnon: bootAction.user.isAnon,\n\t\tpopupEnabled: bootAction.isEnabled,\n\t\tpageToken: bootAction.pageToken,\n\t\tsessionToken: bootAction.sessionToken,\n\t\tpreviewCountBucket: counts.getPreviewCountBucket(\n\t\t\tbootAction.user.previewCount\n\t\t),\n\t\thovercardsSuppressedByGadget: bootAction.isNavPopupsEnabled\n\t};\n\n\tif ( !bootAction.user.isAnon ) {\n\t\tresult.editCountBucket =\n\t\t\tcounts.getEditCountBucket( bootAction.user.editCount );\n\t}\n\n\treturn result;\n}\n\n/**\n * Takes data specific to the action and adds the following properties:\n *\n * * `linkInteractionToken`;\n * * `pageTitleHover` and `namespaceIdHover`; and\n * * `previewType` and `perceivedWait`, if a preview has been shown.\n *\n * The linkInteractionToken is renewed on each new preview dwelling unlike the pageToken which has a\n * lifespan tied to the pageview. It is erroneous to use the same linkInteractionToken across\n * multiple previews even if the previews are for the same link.\n *\n * @param {Object} interaction\n * @param {Object} actionData Data specific to the action, e.g. see\n *  {@link module:reducers/eventLogging~createClosingEvent `createClosingEvent`}\n * @return {Object}\n */\nfunction createEvent( interaction, actionData ) {\n\tactionData.linkInteractionToken = interaction.token;\n\tactionData.pageTitleHover = interaction.title;\n\tactionData.namespaceIdHover = interaction.namespaceId;\n\n\t// Has the preview been shown?\n\tif ( interaction.timeToPreviewShow !== undefined ) {\n\t\tactionData.previewType = interaction.previewType;\n\t\tactionData.perceivedWait = interaction.timeToPreviewShow;\n\t}\n\n\treturn actionData;\n}\n\n/**\n * Creates an event that, when mixed into the base data (see\n * {@link module:reducers/eventLogging~getBaseData `getBaseData`}), represents\n * the user abandoning a link or preview.\n *\n * Since the event should be logged when the user has either abandoned a link or\n * dwelled on a different link, we refer to these events as \"closing\" events as\n * the link interaction has finished and a new one will be created later.\n *\n * If the link interaction is finalized, then no closing event is created.\n *\n * @param {Object} interaction\n * @return {Object|undefined}\n */\nfunction createClosingEvent( interaction ) {\n\tconst actionData = {\n\t\ttotalInteractionTime:\n\t\t\tMath.round( interaction.finished - interaction.started )\n\t};\n\n\tif ( interaction.finalized ) {\n\t\treturn undefined;\n\t}\n\n\t// Has the preview been shown? If so, then, in the context of the\n\t// instrumentation, then the preview has been dismissed by the user\n\t// rather than the user has abandoned the link.\n\tactionData.action =\n\t\tinteraction.timeToPreviewShow ? 'dismissed' : 'dwelledButAbandoned';\n\n\treturn createEvent( interaction, actionData );\n}\n\n/**\n * Reducer for actions that may result in an event being logged with [the\n * Popups schema][0] via EventLogging.\n *\n * The complexity of this reducer reflects the complexity of [the schema][0],\n * which is compounded by the introduction of two delays introduced by the\n * system to provide reasonable performance and a consistent UX.\n *\n * The reducer must:\n *\n * * Accumulate the state required to log events. This state is\n *   referred to as \"the interaction state\" or \"the interaction\";\n * * Enforce the invariant that one event is logged per interaction;\n * * Defend against delayed actions being dispatched; and, as a direct\n *   consequence\n * * Handle transitioning from one interaction to another at the same time.\n *\n * Furthermore, we distinguish between \"finalizing\" and \"closing\" the current\n * interaction state. Since only one event should be logged per link\n * interaction, we say that the interaction state is *finalized* when an event\n * has been logged and is *closed* when a new interaction should be created.\n * In practice, the interaction state is only finalized when the user clicks a\n * link or a preview.\n *\n * [0]: https://meta.wikimedia.org/wiki/Schema:Popups\n *\n * @param {Object} state\n * @param {Object} action\n * @return {Object} The state resulting from reducing the action with the\n *  current state\n */\nexport default function eventLogging( state, action ) {\n\tlet nextCount, newState;\n\tconst actionTypesWithTokens = [\n\t\tactionTypes.FETCH_COMPLETE,\n\t\tactionTypes.ABANDON_END,\n\t\tactionTypes.PREVIEW_SHOW\n\t];\n\n\tif ( state === undefined ) {\n\t\tstate = {\n\t\t\tpreviewCount: undefined,\n\t\t\tbaseData: {},\n\t\t\tinteraction: undefined,\n\t\t\tevent: undefined\n\t\t};\n\t}\n\n\t// Was the action delayed? Then it requires a token to be reduced. Enforce\n\t// this here to avoid repetition and reduce nesting below.\n\tif (\n\t\tactionTypesWithTokens.indexOf( action.type ) !== -1 &&\n\t\t( !state.interaction || action.token !== state.interaction.token )\n\t) {\n\t\treturn state;\n\t}\n\n\t// If there is no interaction ongoing, ignore all actions except for:\n\t// * Application initialization\n\t// * New link dwells (which start a new interaction)\n\t// * Clearing queued events\n\t//\n\t// For example, after ctrl+clicking a link or preview, any other actions\n\t// until the new interaction should be ignored.\n\tif (\n\t\t!state.interaction &&\n\t\taction.type !== actionTypes.BOOT &&\n\t\taction.type !== actionTypes.LINK_DWELL &&\n\t\taction.type !== actionTypes.EVENT_LOGGED &&\n\t\taction.type !== actionTypes.SETTINGS_CHANGE\n\t) {\n\t\treturn state;\n\t}\n\tswitch ( action.type ) {\n\t\tcase actionTypes.BOOT:\n\t\t\treturn nextState( state, {\n\t\t\t\tpreviewCount: action.user.previewCount,\n\t\t\t\tbaseData: getBaseData( action ),\n\t\t\t\tevent: {\n\t\t\t\t\taction: 'pageLoaded'\n\t\t\t\t}\n\t\t\t} );\n\n\t\tcase actionTypes.EVENT_LOGGED:\n\t\t\tnewState = nextState( state, {\n\t\t\t\tevent: undefined\n\t\t\t} );\n\n\t\t\t// If an event was logged with an interaction token, and it is still\n\t\t\t// the current interaction, finish the interaction since logging is\n\t\t\t// the exit point of the state machine and an interaction should never\n\t\t\t// be logged twice.\n\t\t\tif (\n\t\t\t\taction.event.linkInteractionToken &&\n\t\t\t\tstate.interaction &&\n\t\t\t\t( action.event.linkInteractionToken === state.interaction.token )\n\t\t\t) {\n\t\t\t\tnewState.interaction = undefined;\n\t\t\t}\n\t\t\treturn newState;\n\n\t\tcase actionTypes.FETCH_COMPLETE:\n\t\t\treturn nextState( state, {\n\t\t\t\tinteraction: nextState( state.interaction, {\n\t\t\t\t\tpreviewType: action.result.type\n\t\t\t\t} )\n\t\t\t} );\n\n\t\tcase actionTypes.PREVIEW_SHOW:\n\t\t\tnextCount = state.previewCount + 1;\n\n\t\t\treturn nextState( state, {\n\t\t\t\tpreviewCount: nextCount,\n\t\t\t\tbaseData: nextState( state.baseData, {\n\t\t\t\t\tpreviewCountBucket: counts.getPreviewCountBucket( nextCount )\n\t\t\t\t} ),\n\t\t\t\tinteraction: nextState( state.interaction, {\n\t\t\t\t\ttimeToPreviewShow:\n\t\t\t\t\t\tMath.round( action.timestamp - state.interaction.started )\n\t\t\t\t} )\n\t\t\t} );\n\n\t\tcase actionTypes.LINK_DWELL:\n\n\t\t\t// Not a new interaction?\n\t\t\tif ( state.interaction && action.el === state.interaction.link ) {\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tinteraction: nextState( state.interaction, {\n\t\t\t\t\t\tisUserDwelling: true\n\t\t\t\t\t} )\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\treturn nextState( state, {\n\t\t\t\t// TODO: Extract this object into a module that can be shared between\n\t\t\t\t// this and the preview reducer.\n\t\t\t\tinteraction: {\n\t\t\t\t\tlink: action.el,\n\t\t\t\t\ttitle: action.title,\n\t\t\t\t\tnamespaceId: action.namespaceId,\n\t\t\t\t\ttoken: action.token,\n\t\t\t\t\tstarted: action.timestamp,\n\n\t\t\t\t\tisUserDwelling: true\n\t\t\t\t},\n\n\t\t\t\t// Was the user interacting with another link? If so, then log the\n\t\t\t\t// abandoned event.\n\t\t\t\tevent: state.interaction ?\n\t\t\t\t\tcreateClosingEvent( state.interaction ) : undefined\n\t\t\t} );\n\n\t\tcase actionTypes.PREVIEW_DWELL:\n\t\t\treturn nextState( state, {\n\t\t\t\tinteraction: nextState( state.interaction, {\n\t\t\t\t\tisUserDwelling: true\n\t\t\t\t} )\n\t\t\t} );\n\n\t\tcase actionTypes.LINK_CLICK:\n\t\t\treturn nextState( state, {\n\t\t\t\tinteraction: nextState( state.interaction, {\n\t\t\t\t\tfinalized: true\n\t\t\t\t} ),\n\t\t\t\tevent: createEvent( state.interaction, {\n\t\t\t\t\taction: 'opened',\n\t\t\t\t\ttotalInteractionTime:\n\t\t\t\t\t\tMath.round( action.timestamp - state.interaction.started )\n\t\t\t\t} )\n\t\t\t} );\n\n\t\tcase actionTypes.ABANDON_START:\n\t\t\treturn nextState( state, {\n\t\t\t\tinteraction: nextState( state.interaction, {\n\t\t\t\t\tfinished: action.timestamp,\n\n\t\t\t\t\tisUserDwelling: false\n\t\t\t\t} )\n\t\t\t} );\n\n\t\tcase actionTypes.ABANDON_END:\n\t\t\tif ( !state.interaction.isUserDwelling ) {\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tinteraction: undefined,\n\t\t\t\t\tevent: createClosingEvent( state.interaction )\n\t\t\t\t} );\n\t\t\t}\n\n\t\t\treturn state;\n\n\t\tcase actionTypes.SETTINGS_SHOW:\n\t\t\treturn nextState( state, {\n\t\t\t\tevent: createEvent( state.interaction, {\n\t\t\t\t\taction: 'tapped settings cog'\n\t\t\t\t} )\n\t\t\t} );\n\n\t\tcase actionTypes.SETTINGS_CHANGE:\n\t\t\tif ( action.wasEnabled && !action.enabled ) {\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tevent: {\n\t\t\t\t\t\taction: 'disabled',\n\t\t\t\t\t\tpopupEnabled: false\n\t\t\t\t\t}\n\t\t\t\t} );\n\t\t\t} else {\n\t\t\t\treturn state;\n\t\t\t}\n\t\tdefault:\n\t\t\treturn state;\n\t}\n}\n","import eventLogging from './eventLogging';\nimport pageviews from './pageviews';\nimport preview from './preview';\nimport settings from './settings';\nimport statsv from './statsv';\n\nexport default {\n\teventLogging,\n\tpageviews,\n\tpreview,\n\tsettings,\n\tstatsv\n};\n","/**\n * Creates the next state tree from the current state tree and some updates.\n *\n * N.B. OO.copy doesn't copy Element instances, whereas $.extend does.\n * However, OO.copy does copy properties whose values are undefined or null,\n * whereas $.extend doesn't. Since the state tree contains an Element instance\n * - the preview.activeLink property - and we want to copy undefined/null into\n * the state we need to manually iterate over updates and check with\n * hasOwnProperty to copy over to the new state.\n *\n * In [change listeners](/docs/change_listener.md), for example, we talk about\n * the previous state and the current state (the `prevState` and `state`\n * parameters, respectively). Since\n * [reducers](http://redux.js.org/docs/basics/Reducers.html) take the current\n * state and an action and make updates, \"next state\" seems appropriate.\n *\n * @param {Object} state\n * @param {Object} updates\n * @return {Object}\n */\nexport default function nextState( state, updates ) {\n\tconst result = {};\n\tconst hasOwn = Object.prototype.hasOwnProperty;\n\n\tfor ( const key in state ) {\n\t\tif ( hasOwn.call( state, key ) && !hasOwn.call( updates, key ) ) {\n\t\t\tresult[ key ] = state[ key ];\n\t\t}\n\t}\n\n\tfor ( const key in updates ) {\n\t\tif ( hasOwn.call( updates, key ) ) {\n\t\t\tresult[ key ] = updates[ key ];\n\t\t}\n\t}\n\n\treturn result;\n}\n","/**\n * @module reducers/pageviews\n */\n\nimport actionTypes from '../actionTypes';\nimport nextState from './nextState';\n\n/**\n * Reducer for actions that queues and clears events for\n * being logged as virtual pageviews [0]\n *\n * [0]: https://meta.wikimedia.org/wiki/Schema:VirtualPageViews\n *\n * @param {Object} state\n * @param {Object} action\n * @return {Object} The state resulting from reducing the action with the\n *  current state\n */\nexport default function pageviews( state, action ) {\n\tif ( state === undefined ) {\n\t\tstate = {\n\t\t\tpageview: undefined\n\t\t};\n\t}\n\n\tswitch ( action.type ) {\n\t\tcase actionTypes.BOOT:\n\t\t\treturn nextState( state, {\n\t\t\t\tpage: action.page\n\t\t\t} );\n\t\tcase actionTypes.PAGEVIEW_LOGGED:\n\t\t\treturn nextState( state, {\n\t\t\t\tpageview: undefined\n\t\t\t} );\n\t\tcase actionTypes.PREVIEW_SEEN:\n\t\t\treturn nextState( state, {\n\t\t\t\tpageview: {\n\t\t\t\t\t/* eslint-disable camelcase */\n\t\t\t\t\tpage_title: action.title,\n\t\t\t\t\tpage_id: action.pageId,\n\t\t\t\t\tpage_namespace: action.namespace\n\t\t\t\t\t/* eslint-enable camelcase */\n\t\t\t\t}\n\t\t\t} );\n\t\tdefault:\n\t\t\treturn state;\n\t}\n}\n","import actionTypes from '../actionTypes';\nimport nextState from './nextState';\n\n/**\n * Reducer for actions that modify the state of the preview model\n *\n * @param {Object|undefined} state before action\n * @param {Object} action Redux action that modified state.\n *  Must have `type` property.\n * @return {Object} state after action\n */\nexport default function preview( state, action ) {\n\tif ( state === undefined ) {\n\t\tstate = {\n\t\t\tenabled: undefined,\n\t\t\tactiveLink: undefined,\n\t\t\tactiveEvent: undefined,\n\t\t\tactiveToken: '',\n\t\t\tshouldShow: false,\n\t\t\tisUserDwelling: false,\n\t\t\twasClicked: false\n\t\t};\n\t}\n\n\tswitch ( action.type ) {\n\t\tcase actionTypes.BOOT:\n\t\t\treturn nextState( state, {\n\t\t\t\tenabled: action.isEnabled\n\t\t\t} );\n\n\t\tcase actionTypes.SETTINGS_CHANGE:\n\t\t\treturn nextState( state, {\n\t\t\t\tenabled: action.enabled\n\t\t\t} );\n\n\t\tcase actionTypes.LINK_DWELL:\n\t\t\tif ( action.el !== state.activeLink ) {\n\t\t\t\t// New interaction\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tactiveLink: action.el,\n\t\t\t\t\tactiveEvent: action.event,\n\t\t\t\t\tactiveToken: action.token,\n\n\t\t\t\t\t// When the user dwells on a link with their keyboard, a preview is\n\t\t\t\t\t// renderered, and then dwells on another link, the ABANDON_END\n\t\t\t\t\t// action will be ignored.\n\t\t\t\t\t//\n\t\t\t\t\t// Ensure that all the preview is hidden.\n\t\t\t\t\tshouldShow: false,\n\n\t\t\t\t\tisUserDwelling: true,\n\t\t\t\t\tpromise: action.promise\n\t\t\t\t} );\n\t\t\t}\n\t\t\t// Dwelling back into the same link.\n\t\t\treturn nextState( state, {\n\t\t\t\tisUserDwelling: true\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_ABORTED:\n\t\tcase actionTypes.ABANDON_END:\n\t\t\tif ( action.token === state.activeToken && !state.isUserDwelling ) {\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tactiveLink: undefined,\n\t\t\t\t\tactiveToken: undefined,\n\t\t\t\t\tactiveEvent: undefined,\n\t\t\t\t\tfetchResponse: undefined,\n\t\t\t\t\tshouldShow: false\n\t\t\t\t} );\n\t\t\t}\n\t\t\treturn state;\n\n\t\tcase actionTypes.PREVIEW_DWELL:\n\t\t\treturn nextState( state, {\n\t\t\t\tisUserDwelling: true\n\t\t\t} );\n\n\t\tcase actionTypes.ABANDON_START:\n\t\t\treturn nextState( state, {\n\t\t\t\tisUserDwelling: false,\n\t\t\t\twasClicked: false\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_START:\n\t\t\treturn nextState( state, {\n\t\t\t\tfetchResponse: undefined,\n\t\t\t\tpromise: action.promise\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_COMPLETE:\n\t\t\tif ( action.token === state.activeToken ) {\n\t\t\t\treturn nextState( state, {\n\t\t\t\t\tfetchResponse: action.result,\n\t\t\t\t\tshouldShow: state.isUserDwelling\n\t\t\t\t} );\n\t\t\t} // else fall through\n\t\tdefault:\n\t\t\treturn state;\n\t}\n}\n","import actionTypes from '../actionTypes';\nimport nextState from './nextState';\n\n/**\n * Reducer for actions that modify the state of the settings\n *\n * @param {Object} state\n * @param {Object} action\n * @return {Object} state after action\n */\nexport default function settings( state, action ) {\n\tif ( state === undefined ) {\n\t\tstate = {\n\t\t\tshouldShow: false,\n\t\t\tshowHelp: false,\n\t\t\tshouldShowFooterLink: false\n\t\t};\n\t}\n\n\tswitch ( action.type ) {\n\t\tcase actionTypes.SETTINGS_SHOW:\n\t\t\treturn nextState( state, {\n\t\t\t\tshouldShow: true,\n\t\t\t\tshowHelp: false\n\t\t\t} );\n\t\tcase actionTypes.SETTINGS_HIDE:\n\t\t\treturn nextState( state, {\n\t\t\t\tshouldShow: false,\n\t\t\t\tshowHelp: false\n\t\t\t} );\n\t\tcase actionTypes.SETTINGS_CHANGE:\n\t\t\treturn action.wasEnabled === action.enabled ?\n\t\t\t\t// If the setting is the same, just hide the dialogs\n\t\t\t\tnextState( state, {\n\t\t\t\t\tshouldShow: false\n\t\t\t\t} ) :\n\t\t\t\t// If the settings have changed...\n\t\t\t\tnextState( state, {\n\t\t\t\t\t// If we enabled, we just hide directly, no help\n\t\t\t\t\t// If we disabled, keep it showing and let the ui show the help.\n\t\t\t\t\tshouldShow: !action.enabled,\n\t\t\t\t\tshowHelp: !action.enabled,\n\n\t\t\t\t\t// Since the footer link is only ever shown to anonymous users (see\n\t\t\t\t\t// the BOOT case below), state.userIsAnon is always truthy here.\n\t\t\t\t\tshouldShowFooterLink: !action.enabled\n\t\t\t\t} );\n\n\t\tcase actionTypes.BOOT:\n\t\t\treturn nextState( state, {\n\t\t\t\tshouldShowFooterLink: action.user.isAnon && !action.isEnabled\n\t\t\t} );\n\t\tdefault:\n\t\t\treturn state;\n\t}\n}\n","import actionTypes from './../actionTypes';\nimport nextState from './nextState';\n\n/**\n * Reducer for actions that may result in an event being logged via statsv.\n *\n * @param {Object} state\n * @param {Object} action\n * @return {Object} state after action\n */\nexport default function statsv( state, action ) {\n\tstate = state || {};\n\n\tswitch ( action.type ) {\n\t\tcase actionTypes.FETCH_START:\n\t\t\treturn nextState( state, {\n\t\t\t\tfetchStartedAt: action.timestamp\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_END:\n\t\t\treturn nextState( state, {\n\t\t\t\taction: 'timing.PagePreviewsApiResponse',\n\t\t\t\tdata: action.timestamp - state.fetchStartedAt\n\t\t\t} );\n\n\t\tcase actionTypes.FETCH_FAILED:\n\t\t\treturn nextState( state, {\n\t\t\t\taction: 'counter.PagePreviewsApiFailure',\n\t\t\t\tdata: 1\n\t\t\t} );\n\n\t\tcase actionTypes.LINK_DWELL:\n\t\t\treturn nextState( state, {\n\t\t\t\tlinkDwellStartedAt: action.timestamp\n\t\t\t} );\n\n\t\tcase actionTypes.PREVIEW_SHOW:\n\t\t\treturn nextState( state, {\n\t\t\t\taction: 'timing.PagePreviewsPreviewShow',\n\t\t\t\tdata: action.timestamp - state.linkDwellStartedAt\n\t\t\t} );\n\n\t\tcase actionTypes.STATSV_LOGGED:\n\t\t\treturn nextState( state, {\n\t\t\t\taction: null,\n\t\t\t\tdata: null\n\t\t\t} );\n\n\t\tdefault:\n\t\t\treturn state;\n\t}\n}\n","/**\n * @module title\n */\n\n/**\n * Fast, native check if we are parsing a self-link, with the only difference beeing the hash.\n *\n * @param {HTMLAnchorElement} el\n * @return {boolean}\n */\nfunction isOwnPageAnchorLink( el ) {\n\treturn el.hash &&\n\t\t// Note: The protocol is ignored for the sake of simplicity.\n\t\t// Can't compare username and password because they aren't readable from `location`.\n\t\tel.host === location.host &&\n\t\tel.pathname === location.pathname &&\n\t\tel.search === location.search;\n}\n\n/**\n * Gets the title of a local page from an href given some configuration.\n *\n * @param {string} href\n * @param {mw.Map} config\n * @return {string|undefined}\n */\nexport function getTitle( href, config ) {\n\t// Skip every URI that mw.Uri cannot parse\n\tlet linkHref;\n\ttry {\n\t\tlinkHref = new mw.Uri( href );\n\t} catch ( e ) {\n\t\treturn undefined;\n\t}\n\n\t// External links\n\tif ( linkHref.host !== location.hostname ) {\n\t\treturn undefined;\n\t}\n\n\tconst queryLength = Object.keys( linkHref.query ).length;\n\tlet title;\n\n\t// No query params (pretty URL)\n\tif ( !queryLength ) {\n\t\tconst pattern = mw.util.escapeRegExp( config.get( 'wgArticlePath' ) ).replace( '\\\\$1', '([^?#]+)' ),\n\t\t\tmatches = new RegExp( pattern ).exec( linkHref.path );\n\n\t\t// We can't be sure decodeURIComponent() is able to parse every possible match\n\t\ttry {\n\t\t\ttitle = matches && decodeURIComponent( matches[ 1 ] );\n\t\t} catch ( e ) {\n\t\t\t// Will return undefined below\n\t\t}\n\t} else if ( queryLength === 1 && 'title' in linkHref.query ) {\n\t\t// URL is not pretty, but only has a `title` parameter\n\t\ttitle = linkHref.query.title;\n\t}\n\n\treturn title ? `${title}${linkHref.fragment ? `#${linkHref.fragment}` : ''}` : undefined;\n}\n\n/**\n * Given a page title it will return the mediawiki.Title if it is an eligible\n * link for showing page previews, null otherwise\n *\n * @param {string|undefined} title page title to check if it should show preview\n * @param {number[]} contentNamespaces contentNamespaces as specified in\n * wgContentNamespaces\n * @return {mw.Title|null}\n */\nexport function isValid( title, contentNamespaces ) {\n\tif ( !title ) {\n\t\treturn null;\n\t}\n\n\t// Is title in a content namespace?\n\tconst mwTitle = mw.Title.newFromText( title );\n\tif ( mwTitle && contentNamespaces.indexOf( mwTitle.namespace ) >= 0 ) {\n\t\treturn mwTitle;\n\t}\n\n\treturn null;\n}\n\n/**\n * Return an mw.Title from an HTMLAnchorElement if valid for page previews. Convenience\n * method\n *\n * @param {HTMLAnchorElement} el\n * @param {mw.Map} config\n * @return {mw.Title|null}\n */\nexport function fromElement( el, config ) {\n\tif ( isOwnPageAnchorLink( el ) ) {\n\t\t// No need to check the namespace. A self-link can't point to different one.\n\t\ttry {\n\t\t\treturn mw.Title.newFromText( config.get( 'wgPageName' ) + decodeURIComponent( el.hash ) );\n\t\t} catch ( e ) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\treturn isValid(\n\t\tgetTitle( el.href, config ),\n\t\tconfig.get( 'wgContentNamespaces' )\n\t);\n}\n","/**\n * @module renderer\n */\n\nimport wait from '../wait';\nimport { SIZES, createThumbnail } from './thumbnail';\nimport { previewTypes } from '../preview/model';\nimport { renderPreview } from './templates/preview/preview';\nimport { renderReferencePreview } from './templates/referencePreview/referencePreview';\nimport { renderPagePreview } from './templates/pagePreview/pagePreview';\n\nconst $window = $( window );\n\n\n/**\n * Initializes the renderer.\n *\n * @return {void}\n */\nexport function init() {\n}\n\n/**\n * The information passed from a key/mouse event to the renderer.\n *\n * @typedef {Object} ext.popups.PopupTriggerEvent\n * @property {'key'|'mouse'} eventType\n * @property {Element} target\n * @property {DOMRect} clientRect\n * @property {number} clientX\n * @property {number} clientY\n * @property {number} pageXOffset\n * @property {number} pageYOffset\n * @property {number} innerWidth\n * @property {number} innerHeight\n */\n\n\n/**\n * The model of how a view is rendered, which is constructed from a response\n * from the gateway.\n *\n * TODO: Rename `isTall` to `isPortrait`.\n *\n * @typedef {Object} ext.popups.Preview\n * @property {JQuery} el\n * @property {boolean} hasThumbnail\n * @property {Object} thumbnail\n * @property {boolean} isTall Sugar around\n *  `preview.hasThumbnail && thumbnail.isTall`\n */\n\n/**\n * Renders a preview given data from the {@link gateway Gateway}.\n * The preview is rendered and added to the DOM but will remain hidden until\n * the `show` method is called.\n *\n * Previews are rendered at:\n *\n * # The position of the mouse when the user dwells on the link with their\n *   mouse.\n * # The centermost point of the link when the user dwells on the link with\n *   their keyboard or other assistive device.\n *\n * Since the content of the preview doesn't change but its position might, we\n * distinguish between \"rendering\" - generating HTML from a MediaWiki API\n * response - and \"showing/hiding\" - positioning the layout and changing its\n * orientation, if necessary.\n *\n * @param {ext.popups.PreviewModel} model\n * @return {ext.popups.Preview}\n */\nexport function render( model ) {\n\tconst preview = createPreviewWithType( model );\n\n\treturn {\n\t\t/**\n\t\t * Shows the preview given an event representing the user's interaction\n\t\t * with the active link, e.g. an instance of\n\t\t * [MouseEvent](https://developer.mozilla.org/en/docs/Web/API/MouseEvent).\n\t\t *\n\t\t * See `show` for more detail.\n\t\t *\n\t\t * @param {ext.popups.PopupTriggerEvent} event\n\t\t * @param {Object} boundActions The\n\t\t *  [bound action creators](http://redux.js.org/docs/api/bindActionCreators.html)\n\t\t *  that were (likely) created in [boot.js](./boot.js).\n\t\t * @param {string} token The unique token representing the link interaction\n\t\t *  that resulted in showing the preview\n\t\t * @return {JQuery.Promise<void>}\n\t\t */\n\t\tshow( event, boundActions, token ) {\n\t\t\treturn show(\n\t\t\t\tpreview, event, $( event.target ), boundActions, token,\n\t\t\t\tdocument.body, document.documentElement.getAttribute( 'dir' )\n\t\t\t);\n\t\t},\n\n\t\t/**\n\t\t * Hides the preview.\n\t\t *\n\t\t * See `hide` for more detail.\n\t\t *\n\t\t * @return {JQuery.Promise<void>}\n\t\t */\n\t\thide() {\n\t\t\treturn hide( preview );\n\t\t}\n\t};\n}\n/**\n * Creates an instance of a Preview based on\n * the type property of the PreviewModel\n *\n * @param {ext.popups.PreviewModel} model\n * @return {ext.popups.Preview}\n */\nexport function createPreviewWithType( model ) {\n\tswitch ( model.type ) {\n\t\tcase previewTypes.TYPE_PAGE:\n\t\t\treturn createPagePreview( model );\n\t\tcase previewTypes.TYPE_DISAMBIGUATION:\n\t\t\treturn createDisambiguationPreview( model );\n\t\tcase previewTypes.TYPE_REFERENCE:\n\t\t\treturn createReferencePreview( model );\n\t\tdefault:\n\t\t\treturn createEmptyPreview( model );\n\t}\n}\n\n/**\n * Creates an instance of the DTO backing a preview.\n *\n * @param {ext.popups.PagePreviewModel} model\n * @return {ext.popups.Preview}\n */\nfunction createPagePreview( model ) {\n\tconst thumbnail = createThumbnail( model.thumbnail ),\n\t\thasThumbnail = thumbnail !== null;\n\n\treturn {\n\t\tel: renderPagePreview( model, thumbnail ),\n\t\thasThumbnail,\n\t\tthumbnail,\n\t\tisTall: hasThumbnail && thumbnail.isTall\n\t};\n}\n\n/**\n * Creates an instance of the DTO backing a preview. In this case the DTO\n * represents a generic preview, which covers the following scenarios:\n *\n * * The page doesn't exist, i.e. the user hovered over a redlink or a\n *   redirect to a page that doesn't exist.\n * * The page doesn't have a viable extract.\n *\n * @param {ext.popups.PagePreviewModel} model\n * @return {ext.popups.Preview}\n */\nfunction createEmptyPreview( model ) {\n\tconst showTitle = false,\n\t\textractMsg = mw.msg( 'popups-preview-no-preview' ),\n\t\tlinkMsg = mw.msg( 'popups-preview-footer-read' );\n\n\treturn {\n\t\tel: renderPreview( model, showTitle, extractMsg, linkMsg ),\n\t\thasThumbnail: false,\n\t\tisTall: false\n\t};\n}\n\n/**\n * Creates an instance of the disambiguation preview.\n *\n * @param {ext.popups.PagePreviewModel} model\n * @return {ext.popups.Preview}\n */\nfunction createDisambiguationPreview( model ) {\n\tconst showTitle = true,\n\t\textractMsg = mw.msg( 'popups-preview-disambiguation' ),\n\t\tlinkMsg = mw.msg( 'popups-preview-disambiguation-link' );\n\n\treturn {\n\t\tel: renderPreview( model, showTitle, extractMsg, linkMsg ),\n\t\thasThumbnail: false,\n\t\tisTall: false\n\t};\n}\n\n/**\n * @param {ext.popups.ReferencePreviewModel} model\n * @return {ext.popups.Preview}\n */\nfunction createReferencePreview( model ) {\n\treturn {\n\t\tel: renderReferencePreview( model ),\n\t\thasThumbnail: false,\n\t\tisTall: false\n\t};\n}\n\n/**\n * Shows the preview.\n *\n * Extracted from `mw.popups.render.openPopup`.\n *\n * TODO: From the perspective of the client, there's no need to distinguish\n * between rendering and showing a preview. Merge #render and Preview#show.\n *\n * @param {ext.popups.Preview} preview\n * @param {ext.popups.PopupTriggerEvent} event\n * @param {JQuery} $link event target\n * @param {ext.popups.PreviewBehavior} behavior\n * @param {string} token\n * @param {Object} container DOM object to which pointer masks are appended\n * @param {string} dir 'ltr' if left-to-right, 'rtl' if right-to-left.\n * @return {JQuery.Promise<void>} A promise that resolves when the promise has\n *                                faded in.\n */\nexport function show(\n\tpreview, event, $link, behavior, token, container, dir\n) {\n\tconst flippedX = event.clientX > event.innerWidth / 2;\n\tconst flippedY = event.clientY > event.innerHeight / 2;\n\tconst offsetCorrection = event.eventType === 'mouse' ? 18 : 0;\n\n\tconst layout = {\n\t\ttop: event.clientRect.top + event.pageYOffset,\n\t\tbottom: event.clientRect.bottom + event.pageYOffset,\n\t\tpageX: event.clientX + event.pageXOffset + (flippedX ? offsetCorrection : -offsetCorrection),\n\t\tflippedX: dir === 'rtl' ? !flippedX : flippedX,\n\t\tdir\n\t};\n\n\tconst previewElement = preview.el[0]\n\tconst {isTall, hasThumbnail, thumbnail} = preview;\n\tconst {style, dataset} = previewElement;\n\tstyle.setProperty('--link-top', `${Math.round(layout.top)}px`);\n\tstyle.setProperty('--link-bottom', `${Math.round(layout.bottom)}px`);\n\tstyle.setProperty('--offset-x', `${layout.pageX}px`);\n\tdataset.orientation = preview.isTall ? 'landscape' : 'portrait';\n\tdataset.placement = flippedY ? 'above' : 'below';\n\tdataset.alignment = layout.flippedX ? 'left' : 'right';\n\n\tcontainer.appendChild(previewElement);\n\n\t// Trigger fading effect for reference previews after the popup has been rendered\n\tif ( previewElement.classList.contains( 'mwe-popups-type-reference' ) ) {\n\t\t$(previewElement.querySelector('.mwe-popups-scroll')).trigger( 'scroll' );\n\t}\n\t\n\tpreviewElement.addEventListener('transitionend', () => {\n\t\tbindBehavior(previewElement, behavior);\n\t}, {once: true});\n\n\tsetTimeout(() => {\n\t\tpreviewElement.removeAttribute('aria-hidden');\n\t});\n}\n\n/**\n * Binds the behavior to the interactive elements of the preview.\n *\n * @param {HTMLElement} element\n * @param {ext.popups.PreviewBehavior} behavior\n * @return {void}\n */\nexport function bindBehavior( element, behavior ) {\n\telement.addEventListener('mouseenter', behavior.previewDwell);\n\telement.addEventListener('mouseleave', behavior.previewAbandon);\n\telement.addEventListener('click', behavior.click);\n\tconst settingsIcon = element.querySelector('.mwe-popups-settings-icon');\n\tsettingsIcon.setAttribute('href', behavior.settingsUrl);\n\tsettingsIcon.addEventListener('click', event => {\n\t\tevent.stopPropagation();\n\t\tbehavior.showSettings( event );\n\t});\n}\n\n/**\n * Extracted from `mw.popups.render.closePopup`.\n *\n * @param {ext.popups.Preview} preview\n * @return {JQuery.Promise<void>} A promise that resolves when the preview has\n *                                faded out.\n */\nexport function hide( {el} ) {\n\tconst [element] = el;\n\treturn new Promise(resolve => {\n\t\telement.setAttribute('aria-hidden', 'aria-hidden');\n\t\telement.addEventListener('transitionend', () => {\n//\t\t\telement.remove();\n\t\t\tresolve();\n\t\t}, {once: true});\n\t});\n}\n","/**\n * @module settingsDialog\n */\n\nimport { renderSettingsDialog } from './templates/settingsDialog/settingsDialog';\n\n/**\n * Create the settings dialog shown to anonymous users.\n *\n * @param {boolean} navPopupsEnabled\n * @return {JQuery} settings dialog\n */\nexport function createSettingsDialog( navPopupsEnabled ) {\n\tconst choices = [\n\t\t{\n\t\t\tid: 'simple',\n\t\t\tname: mw.msg( 'popups-settings-option-simple' ),\n\t\t\tdescription: mw.msg( 'popups-settings-option-simple-description' ),\n\t\t\tisChecked: true\n\t\t},\n\t\t{\n\t\t\tid: 'advanced',\n\t\t\tname: mw.msg( 'popups-settings-option-advanced' ),\n\t\t\tdescription: mw.msg( 'popups-settings-option-advanced-description' )\n\t\t},\n\t\t{\n\t\t\tid: 'off',\n\t\t\tname: mw.msg( 'popups-settings-option-off' )\n\t\t}\n\t];\n\n\tif ( !navPopupsEnabled ) {\n\t\t// remove the advanced option\n\t\tchoices.splice( 1, 1 );\n\t}\n\n\treturn renderSettingsDialog( {\n\t\theading: mw.msg( 'popups-settings-title' ),\n\t\tcloseLabel: mw.msg( 'popups-settings-cancel' ),\n\t\tsaveLabel: mw.msg( 'popups-settings-save' ),\n\t\thelpText: mw.msg( 'popups-settings-help' ),\n\t\tokLabel: mw.msg( 'popups-settings-help-ok' ),\n\t\tchoices\n\t} );\n}\n","/**\n * @module settingsDialogRenderer\n */\n\nimport { createSettingsDialog } from './settingsDialog';\n\n/**\n * Creates a render function that will create the settings dialog and return\n * a set of methods to operate on it\n *\n * @return {Function} render function\n */\nexport default function createSettingsDialogRenderer() {\n\t/**\n\t * Cached settings dialog\n\t *\n\t * @type {JQuery}\n\t */\n\tlet $dialog,\n\t\t/**\n\t\t * Cached settings overlay\n\t\t *\n\t\t * @type {JQuery}\n\t\t */\n\t\t$overlay;\n\n\t/**\n\t * Renders the relevant form and labels in the settings dialog\n\t *\n\t * @param {Object} boundActions\n\t * @return {Object} object with methods to affect the rendered UI\n\t */\n\treturn ( boundActions ) => {\n\t\tif ( !$dialog ) {\n\t\t\t$dialog = createSettingsDialog( isNavPopupsEnabled() );\n\t\t\t$overlay = $( '<div>' ).addClass( 'mwe-popups-overlay' );\n\n\t\t\t// Setup event bindings\n\n\t\t\t$dialog.find( '.save' ).on( 'click', () => {\n\t\t\t\t// Find the selected value (simple|advanced|off)\n\t\t\t\tconst selected = getSelectedSetting( $dialog ),\n\t\t\t\t\t// Only simple means enabled, advanced is disabled in favor of\n\t\t\t\t\t// NavPops and off means disabled.\n\t\t\t\t\tenabled = selected === 'simple';\n\n\t\t\t\tboundActions.saveSettings( enabled );\n\t\t\t} );\n\t\t\t$dialog.find( '.close, .okay' ).on( 'click', boundActions.hideSettings );\n\t\t}\n\n\t\treturn {\n\t\t\t/**\n\t\t\t * Append the dialog and overlay to a DOM element\n\t\t\t *\n\t\t\t * @param {HTMLElement} el\n\t\t\t * @return {void}\n\t\t\t */\n\t\t\tappendTo( el ) {\n\t\t\t\t$overlay.appendTo( el );\n\t\t\t\t$dialog.appendTo( $overlay );\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * Show the settings element and position it correctly\n\t\t\t *\n\t\t\t * @return {void}\n\t\t\t */\n\t\t\tshow() {\n\t\t\t\t$overlay.show();\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * Hide the settings dialog.\n\t\t\t *\n\t\t\t * @return {void}\n\t\t\t */\n\t\t\thide() {\n\t\t\t\t$overlay.hide();\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * Toggle the help dialog on or off\n\t\t\t *\n\t\t\t * @param {boolean} visible if you want to show or hide the help dialog\n\t\t\t * @return {void}\n\t\t\t */\n\t\t\ttoggleHelp( visible ) {\n\t\t\t\ttoggleHelp( $dialog, visible );\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * Update the form depending on the enabled flag\n\t\t\t *\n\t\t\t * If false and no navpops, then checks 'off'\n\t\t\t * If true, then checks 'on'\n\t\t\t * If false, and there are navpops, then checks 'advanced'\n\t\t\t *\n\t\t\t * @param {boolean} enabled if page previews are enabled\n\t\t\t * @return {void}\n\t\t\t */\n\t\t\tsetEnabled( enabled ) {\n\t\t\t\tlet name = 'off';\n\t\t\t\tif ( enabled ) {\n\t\t\t\t\tname = 'simple';\n\t\t\t\t} else if ( isNavPopupsEnabled() ) {\n\t\t\t\t\tname = 'advanced';\n\t\t\t\t}\n\n\t\t\t\t// Check the appropriate radio button\n\t\t\t\t$dialog.find( `#mwe-popups-settings-${name}` )\n\t\t\t\t\t.prop( 'checked', true );\n\t\t\t}\n\t\t};\n\t};\n}\n\n/**\n * Get the selected value on the radio button\n *\n * @param {JQuery.Object} $el the element to extract the setting from\n * @return {string} Which should be (simple|advanced|off)\n */\nfunction getSelectedSetting( $el ) {\n\treturn $el.find(\n\t\t'input[name=mwe-popups-setting]:checked, #mwe-popups-settings'\n\t).val();\n}\n\n/**\n * Toggles the visibility between a form and the help\n *\n * @param {JQuery.Object} $el element that contains form and help\n * @param {boolean} visible if the help should be visible, or the form\n * @return {void}\n */\nfunction toggleHelp( $el, visible ) {\n\t// eslint-disable-next-line no-jquery/no-global-selector\n\tconst $dialog = $( '#mwe-popups-settings' ),\n\t\tformSelectors = 'main, .save, .close',\n\t\thelpSelectors = '.mwe-popups-settings-help, .okay';\n\n\tif ( visible ) {\n\t\t$dialog.find( formSelectors ).hide();\n\t\t$dialog.find( helpSelectors ).show();\n\t} else {\n\t\t$dialog.find( formSelectors ).show();\n\t\t$dialog.find( helpSelectors ).hide();\n\t}\n}\n\n/**\n * Checks if the NavigationPopups gadget is enabled by looking at the global\n * variables\n *\n * @return {boolean} if navpops was found to be enabled\n */\nfunction isNavPopupsEnabled() {\n\t/* global pg */\n\treturn typeof pg !== 'undefined' && pg.fn.disablePopups !== undefined;\n}\n","/**\n * @module pagePreview\n */\n\nimport { renderPopup } from '../popup/popup';\nimport { createTemplate } from '../templateUtil';\nimport templateHTML from '!raw-loader!./pagePreview.html'\nconst cloneFragment = createTemplate(templateHTML);\n\nlet preview = null\nlet previousElement = null\nlet previousModel = null\n/**\n * @param {ext.popups.PagePreviewModel} model\n * @param {ext.popups.Thumbnail|null} thumbnail\n * @return {JQuery}\n */\n\nexport function renderPagePreview(\n\tmodel, thumbnail\n) {\n\tif (model === previousModel) {\n\t\treturn previousElement;\n\t}\n\tpreview = cloneFragment();\n\n\tconst discreet = preview.querySelector('.mwe-popups-discreet');\n\tconst extract = preview.querySelector('.mwe-popups-extract');\n\n\tif (thumbnail) {\n\t\tdiscreet.appendChild(thumbnail.el[0]);\n\t\tdiscreet.setAttribute('href', model.url);\n\t\tif (thumbnail.isNarrow) {\n\t\t\tpreview.classList.add('mwe-popups-narrow-thumbnail');\n\t\t}\n\t\tdiscreet.removeAttribute('aria-hidden');\n\t} else {\n\t\tdiscreet.setAttribute('aria-hidden', true);\n\t}\n\n\textract.setAttribute('href', model.url);\n\textract.setAttribute('lang', model.languageCode);\n\textract.setAttribute('dir', model.languageDirection);\n\n\tconst footer = preview.querySelector('footer');\n\n\tif ( model.extract ) {\n\t\tif (thumbnail && thumbnail.narrow) {\n\t\t\tfooter.classList.add('mwe-popups-narrow-thumbnail');\n\t\t\tfooter.style.setProperty('--thumbnail-offset', thumbnail.offset);\n\t\t}\n\t\tmodel.extract.forEach(e => extract.appendChild(e));\n\t}\n\n\tconst $el = renderPopup( model.type, preview);\n\tpreviousElement = $el;\n\treturn $el;\n}\n","/**\n * @module popup\n */\n\nimport { createTemplate } from '../templateUtil';\nimport templateHTML from '!raw-loader!./popup.html'\n\nconst cloneFragment = createTemplate(templateHTML);\n\n/**\n * @param {ext.popups.previewTypes} type\n * @param {Element} innerElement the inner element.\n * @return {JQuery}\n */\n\nlet popup = null\nexport function renderPopup( type, innerElement ) {\n\tpopup = popup || cloneFragment().querySelector('.mwe-popups');\n\tpopup.classList.add(`mwe-popups-type-${type}`);\n\tconst container = popup.querySelector('.mwe-popups-container');\n\tif (innerElement !== container.firstChild) {\n\t\twhile (container.firstChild)\n\t\t\tcontainer.firstChild.remove();\n\t\tcontainer.appendChild(innerElement);\n\t}\n\treturn $(popup);\n}\n","/**\n * @module preview\n */\n\nimport { renderPopup } from '../popup/popup';\nimport { escapeHTML, createTemplate } from '../templateUtil';\nimport templateHTML from '!raw-loader!./preview.html'\n\nconst cloneFragment = createTemplate(templateHTML);\n\n/**\n * @param {ext.popups.PagePreviewModel} model\n * @param {boolean} showTitle\n * @param {string} extractMsg\n * @param {string} linkMsg\n * @return {JQuery}\n */\n\n\nexport function renderPreview(\n\tmodel, showTitle, extractMsg, linkMsg\n) {\n\tconst title = escapeHTML( model.title );\n\textractMsg = escapeHTML( extractMsg );\n\tlinkMsg = escapeHTML( linkMsg );\n\tconst preview = cloneFragment();\n\tconst titleElement = preview.querySelector('.mwe-popups-title');\n\tconst linkElement = preview.querySelector('.mwe-popups-read-link')\n\tpreview.querySelector('.mw-ui-icon').classList.add(`mw-ui-icon-preview-${model.type}`);\n\ttitleElement.innerHTML = showTitle ? title : '';\n\tpreview.querySelector('.mwe-popups-extract').setAttribute('href', model.url);\n\tpreview.querySelector('.mwe-popups-message').innerHTML = extractMsg;\t\n\tlinkElement.innerHTML = linkMsg;\n\tlinkElement.setAttribute('href', model.url);\n\treturn renderPopup(model.type, preview);\n}\n","/**\n * @module referencePreview\n */\n\nimport { renderPopup } from '../popup/popup';\nimport { escapeHTML } from '../templateUtil';\n\n// Known citation type strings currently supported with icons and messages.\nconst KNOWN_TYPES = [ 'book', 'journal', 'news', 'web' ];\n\nconst LOGGING_SCHEMA = 'event.ReferencePreviewsPopups';\nlet isTracking = false;\n$( () => {\n\tif ( mw.config.get( 'wgPopupsReferencePreviews' ) &&\n\t\tnavigator.sendBeacon &&\n\t\tmw.config.get( 'wgIsArticle' ) &&\n\t\t!isTracking\n\t) {\n\t\tisTracking = true;\n\t\tmw.track( LOGGING_SCHEMA, { action: 'pageview' } );\n\t}\n} );\n\n/**\n * @param {ext.popups.ReferencePreviewModel} model\n * @return {JQuery}\n */\nexport function renderReferencePreview(\n\tmodel\n) {\n\tconst type = KNOWN_TYPES.indexOf( model.referenceType ) < 0 ? 'generic' : model.referenceType,\n\t\ttitleMsg = `popups-refpreview-${type === 'generic' ? 'reference' : type}`,\n\t\t// The following messages are used here:\n\t\t// * popups-refpreview-book\n\t\t// * popups-refpreview-journal\n\t\t// * popups-refpreview-news\n\t\t// * popups-refpreview-reference\n\t\t// * popups-refpreview-web\n\t\ttitle = escapeHTML( mw.msg( titleMsg ) );\n\n\tconst $el = renderPopup( model.type,\n\t\t`\n\t\t\t<div class='mwe-popups-extract'>\n\t\t\t\t<div class='mwe-popups-scroll'>\n\t\t\t\t\t<strong class='mwe-popups-title'>\n\t\t\t\t\t\t<span class='mw-ui-icon mw-ui-icon-element mw-ui-icon-reference-${type}'></span>\n\t\t\t\t\t\t${title}\n\t\t\t\t\t</strong>\n\t\t\t\t\t<div class='mw-parser-output'>${model.extract}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class='mwe-popups-fade' />\n\t\t\t</div>\n\t\t`\n\t);\n\n\t// Make sure to not destroy existing targets, if any\n\t$el.find( '.mwe-popups-extract a[href][class~=\"external\"]:not([target])' ).each( ( i, a ) => {\n\t\ta.target = '_blank';\n\t\t// Don't let the external site access and possibly manipulate window.opener.location\n\t\ta.rel = `${a.rel ? `${a.rel} ` : ''}noopener`;\n\t} );\n\n\t// We assume elements that benefit from being collapsible are to large for the popup\n\t$el.find( '.mw-collapsible' ).replaceWith( $( '<div>' )\n\t\t.addClass( 'mwe-collapsible-placeholder' )\n\t\t.append(\n\t\t\t$( '<span>' )\n\t\t\t\t.addClass( 'mw-ui-icon mw-ui-icon-element mw-ui-icon-infoFilled' ),\n\t\t\t$( '<div>' )\n\t\t\t\t.addClass( 'mwe-collapsible-placeholder-label' )\n\t\t\t\t.text( mw.msg( 'popups-refpreview-collapsible-placeholder' ) )\n\t\t)\n\t);\n\n\t// Undo remaining effects from the jquery.tablesorter.js plugin\n\t$el.find( 'table.sortable' ).removeClass( 'sortable jquery-tablesorter' )\n\t\t.find( '.headerSort' ).removeClass( 'headerSort' ).attr( { tabindex: null, title: null } );\n\n\tif ( isTracking ) {\n\t\t$el.find( '.mw-parser-output' ).on( 'click', 'a', () => {\n\t\t\tmw.track( LOGGING_SCHEMA, {\n\t\t\t\taction: 'clickedReferencePreviewsContentLink'\n\t\t\t} );\n\t\t} );\n\t}\n\n\t$el.find( '.mwe-popups-scroll' ).on( 'scroll', function ( e ) {\n\t\tconst element = e.target,\n\t\t\t// We are dealing with floating point numbers here when the page is zoomed!\n\t\t\tscrolledToBottom = element.scrollTop >= element.scrollHeight - element.clientHeight - 1;\n\n\t\tif ( isTracking ) {\n\t\t\tif ( !element.isOpenRecorded ) {\n\t\t\t\tmw.track( LOGGING_SCHEMA, {\n\t\t\t\t\taction: 'poppedOpen',\n\t\t\t\t\tscrollbarsPresent: element.scrollHeight > element.clientHeight\n\t\t\t\t} );\n\t\t\t\telement.isOpenRecorded = true;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\telement.scrollTop > 0 &&\n\t\t\t\t!element.isScrollRecorded\n\t\t\t) {\n\t\t\t\tmw.track( LOGGING_SCHEMA, {\n\t\t\t\t\taction: 'scrolled'\n\t\t\t\t} );\n\t\t\t\telement.isScrollRecorded = true;\n\t\t\t}\n\t\t}\n\n\t\tif ( !scrolledToBottom && element.isScrolling ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst $extract = $( element ).parent(),\n\t\t\thasHorizontalScroll = element.scrollWidth > element.clientWidth,\n\t\t\tscrollbarHeight = element.offsetHeight - element.clientHeight,\n\t\t\thasVerticalScroll = element.scrollHeight > element.clientHeight,\n\t\t\tscrollbarWidth = element.offsetWidth - element.clientWidth;\n\t\t$extract.find( '.mwe-popups-fade' ).css( {\n\t\t\tbottom: hasHorizontalScroll ? `${scrollbarHeight}px` : 0,\n\t\t\tright: hasVerticalScroll ? `${scrollbarWidth}px` : 0\n\t\t} );\n\n\t\telement.isScrolling = !scrolledToBottom;\n\t\t$extract.toggleClass( 'mwe-popups-fade-out', element.isScrolling );\n\t} );\n\n\treturn $el;\n}\n","/**\n * @module settingsDialog\n */\n\nimport { escapeHTML } from '../templateUtil';\n\n/**\n * @typedef {Object} SettingsModel\n * @property {string} heading\n * @property {string} closeLabel\n * @property {string} saveLabel\n * @property {string} helpText\n * @property {string} okLabel\n * @property {SettingsChoiceModel[]} [choices]\n *\n * @global\n */\n\n/**\n * @typedef {Object} SettingsChoiceModel\n * @property {string} id Portion of the elements' IDs and value of the input.\n * @property {string} name\n * @property {string} [description]\n * @property {boolean} [isChecked] Whether the setting is checked.\n *\n * @global\n */\n\n/**\n * @param {SettingsChoiceModel[]} [choices]\n * @return {SettingsChoiceModel}\n */\nfunction escapeChoices( choices = [] ) {\n\treturn choices.map(\n\t\t( { id, name, description, isChecked } ) =>\n\t\t\t( {\n\t\t\t\tid: escapeHTML( id ),\n\t\t\t\tname: escapeHTML( name ),\n\t\t\t\tdescription: description ? escapeHTML( description ) : '',\n\t\t\t\tisChecked\n\t\t\t} )\n\t);\n}\n\n/**\n * @param {SettingsModel} model\n * @return {JQuery}\n */\nexport function renderSettingsDialog( model ) {\n\tconst heading = escapeHTML( model.heading ),\n\t\tsaveLabel = escapeHTML( model.saveLabel ),\n\t\tcloseLabel = escapeHTML( model.closeLabel ),\n\t\thelpText = escapeHTML( model.helpText ),\n\t\tokLabel = escapeHTML( model.okLabel ),\n\t\tchoices = escapeChoices( model.choices );\n\treturn $( $.parseHTML( `\n\t\t<section id='mwe-popups-settings'>\n\t\t\t<header>\n\t\t\t\t<div>\n\t\t\t\t\t<div class='mw-ui-icon mw-ui-icon-element mw-ui-icon-popups-close close'>${closeLabel}</div>\n\t\t\t\t</div>\n\t\t\t\t<h1>${heading}</h1>\n\t\t\t\t<div>\n\t\t\t\t\t<button class='save mw-ui-button mw-ui-progressive'>${saveLabel}</button>\n\t\t\t\t\t<button class='okay mw-ui-button mw-ui-progressive' style='display:none;'>${okLabel}</button>\n\t\t\t\t</div>\n\t\t\t</header>\n\t\t\t<main id='mwe-popups-settings-form'>\n\t\t\t\t<form>\n\t\t\t\t\t${choices.map( ( { id, name, description, isChecked } ) => `\n\t\t\t\t\t<p>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tname='mwe-popups-setting'\n\t\t\t\t\t\t\t${isChecked ? 'checked' : ''}\n\t\t\t\t\t\t\tvalue='${id}'\n\t\t\t\t\t\t\ttype='radio'\n\t\t\t\t\t\t\tid='mwe-popups-settings-${id}'>\n\t\t\t\t\t\t<label for='mwe-popups-settings-${id}'>\n\t\t\t\t\t\t\t<span>${name}</span>\n\t\t\t\t\t\t\t${description}\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</p>` ).join( '' )}\n\t\t\t\t</form>\n\t\t\t</main>\n\t\t\t<div class='mwe-popups-settings-help' style='display:none;'>\n\t\t\t\t<div class=\"mw-ui-icon mw-ui-icon-element mw-ui-icon-footer\"></div>\n\t\t\t\t<p>${helpText}</p>\n\t\t\t</div>\n\t\t</section>\n\t`.trim() ) );\n}\n","/**\n * @module templateUtil\n */\n\n/**\n * @param {string} str\n * @return {string} The string with any HTML entities escaped.\n */\nexport function escapeHTML( str ) {\n\treturn mw.html.escape( str );\n}\n\n/**\n * @param {string} html the html of the template\n * @return {DocumentFragment} A cloned fragment.\n */\nexport function createTemplate( html ) {\n\tlet template = null\n\n\tconst getTemplate = () => {\n\t\tif (!template) {\n\t\t\ttemplate = document.createElement('template');\n\t\t\ttemplate.innerHTML = html;\n\t\t}\n\n\t\treturn template;\n\t}\n\n\treturn () => getTemplate().content.cloneNode(true);\n}","/**\n * @module thumbnail\n */\n\nimport constants from '../constants';\n\nexport const SIZES = {\n\tportraitImage: {\n\t\th: 250, // Exact height\n\t\tw: 203 // Max width\n\t},\n\tlandscapeImage: {\n\t\th: 200, // Max height\n\t\tw: 320 // Exact Width\n\t}\n};\n\n/**\n * @typedef {Object} ext.popups.Thumbnail\n * @property {JQuery} el\n * @property {boolean} isTall Whether or not the thumbnail is portrait\n * @property {number} width\n * @property {number} height\n * @property {boolean} isNarrow whether the thumbnail is portrait and also\n *  thinner than the default portrait thumbnail width\n *  (as defined in SIZES.portraitImage.w)\n * @property {number} offset in pixels between the thumbnail width and the\n *  standard portrait thumbnail width (as defined in SIZES.portraitImage.w)\n */\n\n/**\n * Creates a thumbnail from the representation of a thumbnail returned by the\n * PageImages MediaWiki API query module.\n *\n * If there's no thumbnail, the thumbnail is too small, or the thumbnail's URL\n * contains characters that could be used to perform an\n * [XSS attack via CSS](https://www.owasp.org/index.php/Testing_for_CSS_Injection_(OTG-CLIENT-005)),\n * then `null` is returned.\n *\n * Extracted from `mw.popups.renderer.article.createThumbnail`.\n *\n * @param {Object} rawThumbnail\n * @return {ext.popups.Thumbnail|null}\n */\nexport function createThumbnail( rawThumbnail ) {\n\tconst devicePixelRatio = constants.BRACKETED_DEVICE_PIXEL_RATIO;\n\n\tif ( !rawThumbnail ) {\n\t\treturn null;\n\t}\n\n\tconst tall = rawThumbnail.width < rawThumbnail.height;\n\tconst thumbWidth = rawThumbnail.width / devicePixelRatio;\n\tconst thumbHeight = rawThumbnail.height / devicePixelRatio;\n\n\tif (\n\t\t// Image too small for landscape display\n\t\t( !tall && thumbWidth < SIZES.landscapeImage.w ) ||\n\t\t// Image too small for portrait display\n\t\t( tall && thumbHeight < SIZES.portraitImage.h ) ||\n\t\t// These characters in URL that could inject CSS and thus JS\n\t\t(\n\t\t\trawThumbnail.source.indexOf( '\\\\' ) > -1 ||\n\t\t\trawThumbnail.source.indexOf( '\\'' ) > -1 ||\n\t\t\trawThumbnail.source.indexOf( '\"' ) > -1\n\t\t)\n\t) {\n\t\treturn null;\n\t}\n\n\tlet x, y, width, height;\n\tif ( tall ) {\n\t\tx = ( thumbWidth > SIZES.portraitImage.w ) ?\n\t\t\t( ( thumbWidth - SIZES.portraitImage.w ) / -2 ) :\n\t\t\t( SIZES.portraitImage.w - thumbWidth );\n\t\ty = ( thumbHeight > SIZES.portraitImage.h ) ?\n\t\t\t( ( thumbHeight - SIZES.portraitImage.h ) / -2 ) : 0;\n\t\twidth = SIZES.portraitImage.w;\n\t\theight = SIZES.portraitImage.h;\n\n\t\t// Special handling for thin tall images\n\t\t// https://phabricator.wikimedia.org/T192928#4312088\n\t\tif ( thumbWidth < width ) {\n\t\t\tx = 0;\n\t\t\twidth = thumbWidth;\n\t\t}\n\t} else {\n\t\tx = 0;\n\t\ty = ( thumbHeight > SIZES.landscapeImage.h ) ?\n\t\t\t( ( thumbHeight - SIZES.landscapeImage.h ) / -2 ) : 0;\n\t\twidth = SIZES.landscapeImage.w;\n\t\theight = ( thumbHeight > SIZES.landscapeImage.h ) ?\n\t\t\tSIZES.landscapeImage.h : thumbHeight;\n\t}\n\n\tconst isNarrow = tall && thumbWidth < SIZES.portraitImage.w;\n\tconst el = document.createElement('img');\n\tel.className = 'mwe-popups-thumbnail';\n\tel.src = rawThumbnail.source;\n\treturn {el: $(el), isTall: tall, isNarrow, width: thumbWidth, height: thumbHeight};\n}\n","/**\n * @module userSettings\n */\n\n/**\n * @interface UserSettings\n *\n * @global\n */\n\nconst IS_ENABLED_KEY = 'mwe-popups-enabled',\n\tPREVIEW_COUNT_KEY = 'ext.popups.core.previewCount';\n\n/**\n * Creates an object whose methods encapsulate all interactions with the UA's\n * storage.\n *\n * @param {Object} storage The `mw.storage` singleton instance\n *\n * @return {UserSettings}\n */\nexport default function createUserSettings( storage ) {\n\treturn {\n\t\t/**\n\t\t * Gets whether the user has previously enabled Page Previews.\n\t\t *\n\t\t * N.B. that if the user hasn't previously enabled or disabled Page\n\t\t * Previews, i.e. userSettings.setIsEnabled(true), then they are treated as\n\t\t * if they have enabled them.\n\t\t *\n\t\t * @method\n\t\t * @name UserSettings#getIsEnabled\n\t\t * @return {boolean}\n\t\t */\n\t\tgetIsEnabled() {\n\t\t\treturn storage.get( IS_ENABLED_KEY ) !== '0';\n\t\t},\n\n\t\t/**\n\t\t * Sets whether the user has enabled Page Previews.\n\t\t *\n\t\t * @method\n\t\t * @name UserSettings#setIsEnabled\n\t\t * @param {boolean} isEnabled\n\t\t * @return {void}\n\t\t */\n\t\tsetIsEnabled( isEnabled ) {\n\t\t\tstorage.set( IS_ENABLED_KEY, isEnabled ? '1' : '0' );\n\t\t},\n\n\t\t/**\n\t\t * Gets whether the user has previously enabled **or disabled** Page\n\t\t * Previews.\n\t\t *\n\t\t * @method\n\t\t * @name UserSettings#hasIsEnabled\n\t\t * @return {boolean}\n\t\t */\n\t\thasIsEnabled() {\n\t\t\tconst value = storage.get( IS_ENABLED_KEY );\n\n\t\t\treturn Boolean( value ) !== false;\n\t\t},\n\n\t\t/**\n\t\t * Gets the number of previews that the user has seen.\n\t\t *\n\t\t * - If the storage isn't available, then -1 is returned.\n\t\t * - If the value in storage is not a number it will override stored value\n\t\t *   to 0\n\t\t *\n\t\t * @method\n\t\t * @name UserSettings#getPreviewCount\n\t\t * @return {number}\n\t\t */\n\t\tgetPreviewCount() {\n\t\t\tconst result = storage.get( PREVIEW_COUNT_KEY );\n\n\t\t\tif ( result === false ) {\n\t\t\t\treturn -1;\n\t\t\t} else if ( result === null ) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tlet count = parseInt( result, 10 );\n\n\t\t\t// stored number is not a zero, override it to zero and store new value\n\t\t\tif ( isNaN( count ) ) {\n\t\t\t\tcount = 0;\n\t\t\t\tthis.setPreviewCount( count );\n\t\t\t}\n\t\t\treturn count;\n\t\t},\n\n\t\t/**\n\t\t * Sets the number of previews that the user has seen.\n\t\t *\n\t\t * @method\n\t\t * @name UserSettings#setPreviewCount\n\t\t * @param {number} count\n\t\t * @return {void}\n\t\t */\n\t\tsetPreviewCount( count ) {\n\t\t\tstorage.set( PREVIEW_COUNT_KEY, count.toString() );\n\t\t}\n\t};\n}\n","/**\n * @module wait\n */\n\n/**\n * Sugar around `window.setTimeout`.\n *\n * @example\n * import wait from './wait';\n *\n * wait( 150 )\n *   .then( () => {\n *     // Continue processing...\n *   } );\n *\n * @param {number} delay The number of milliseconds to wait\n * @return {jQuery.Promise}\n */\nexport default function wait( delay ) {\n\tconst deferred = $.Deferred();\n\tsetTimeout( () => deferred.resolve(), delay );\n\treturn deferred.promise();\n}\n"],"sourceRoot":""}